<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aiaxcart Premium Shop</title>

  <!-- Bootstrap / Icons / Supabase -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #FFB0B5;
      --secondary: #FFD3D6;
      --dark: #382f2c;
      --light: #fefaf7;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--dark);
    }

    .navbar {
      background-color: var(--secondary);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .navbar-brand {
      font-weight: 700;
      color: var(--dark);
    }

    .navbar-brand span {
      color: var(--primary);
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: none;
      transition: transform 0.2s;
      margin-bottom: 1.5rem;
      background: white;
    }

    .card:hover {
      transform: translateY(-3px);
    }

    .category-tab {
      cursor: pointer;
      padding: 8px 18px;
      border-radius: 30px;
      margin: 0 5px 8px 0;
      transition: all 0.3s;
      font-size: 0.9rem;
      font-weight: 500;
      background: white;
      border: 1px solid #f0c5c8;
      white-space: nowrap;
    }

    .category-tab.active {
      background-color: var(--primary);
      color: white;
      border-color: transparent;
    }

    .product-card {
      height: 100%;
    }

    .product-img {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: var(--primary);
    }

    .toast-container {
      z-index: 9999;
    }

    .buyer-profile-img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background-color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.6rem;
      font-weight: bold;
      margin: 0 auto 10px;
    }

    .order-status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-confirmed {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .status-delivered {
      background-color: #d4edda;
      color: #155724;
    }

    .status-cancelled {
      background-color: #f8d7da;
      color: #721c24;
    }

    .nav-pills .nav-link {
      border-radius: 999px;
      font-size: 0.9rem;
      padding: 0.4rem 0.9rem;
      color: var(--dark);
    }

    .nav-pills .nav-link.active {
      background-color: var(--primary);
      color: #fff;
    }

    .rules-list li {
      margin-bottom: 0.3rem;
      font-size: 0.9rem;
    }

    .small-muted {
      font-size: 0.8rem;
      color: #8b7f7a;
    }

    .product-stock-pill {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 12px;
      background: #fff5f6;
      color: #ad5b64;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .product-price-pill {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.95rem;
    }

    .hidden {
      display: none !important;
    }

    @media (max-width: 991px) {
      .right-panel {
        margin-top: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <!-- Toasts -->
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="#">
        üõí <span>Aiaxcart Premium</span> Shop
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" href="#">Products</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#tab-rules-anchor">Rules</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#tab-orders-anchor">My Orders</a>
          </li>
        </ul>
        <div class="d-flex align-items-center">
          <span id="userEmailLabel" class="me-2 small-muted"></span>
          <button id="btnLoginOpen" class="btn btn-sm btn-outline-dark me-2">
            <i class="fa fa-user"></i> Login / Sign up
          </button>
          <button id="btnLogout" class="btn btn-sm btn-outline-danger d-none">
            <i class="fa fa-sign-out-alt"></i>
          </button>
          <a href="./admin.html" class="btn btn-sm btn-outline-secondary ms-2">
            Admin
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <main class="py-4">
    <div class="container">
      <div class="row">
        <!-- LEFT: PRODUCTS -->
        <div class="col-lg-8">
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title mb-2">Browse Premium Accounts</h5>
              <p class="small-muted mb-2">
                All products are visible even if currently out of stock. You must login before checking out.
              </p>
              <div class="d-flex flex-wrap">
                <button class="category-tab active" data-category="all">All</button>
                <button class="category-tab" data-category="entertainment">Entertainment</button>
                <button class="category-tab" data-category="streaming">Streaming</button>
                <button class="category-tab" data-category="educational">Educational</button>
                <button class="category-tab" data-category="editing">Editing</button>
                <button class="category-tab" data-category="ai">AI</button>
              </div>
            </div>
          </div>

          <div id="productsRow" class="row">
            <!-- JS renders product cards here -->
          </div>
        </div>

        <!-- RIGHT: PROFILE / TABS -->
        <div class="col-lg-4 right-panel">
          <div class="card mb-3">
            <div class="card-body text-center">
              <div class="buyer-profile-img" id="buyerAvatar">?</div>
              <h6 id="buyerGreeting" class="mb-0">Welcome, Guest</h6>
              <p class="small-muted mb-1" id="buyerStatusText">
                Login to track your orders and delivered accounts.
              </p>
            </div>
          </div>

          <div class="card mb-3" id="tab-rules-anchor">
            <div class="card-body">
              <ul class="nav nav-pills mb-3" id="buyerTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="tab-rules" data-bs-toggle="pill" data-bs-target="#pane-rules" type="button" role="tab">
                    Rules
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="tab-feedback" data-bs-toggle="pill" data-bs-target="#pane-feedback" type="button" role="tab">
                    Feedback
                  </button>
                </li>
                <li class="nav-item" role="presentation" id="tab-orders-anchor">
                  <button class="nav-link" id="tab-orders" data-bs-toggle="pill" data-bs-target="#pane-orders" type="button" role="tab">
                    My Orders
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="tab-delivered" data-bs-toggle="pill" data-bs-target="#pane-delivered" type="button" role="tab">
                    Delivered Accounts
                  </button>
                </li>
              </ul>

              <div class="tab-content" id="buyerTabsContent" style="max-height: 420px; overflow-y: auto;">
                <!-- RULES -->
                <div class="tab-pane fade show active" id="pane-rules" role="tabpanel" aria-labelledby="tab-rules">
                  <div class="mb-2">
                    <input id="rulesSearchInput" type="text" class="form-control form-control-sm" placeholder="Search rules...">
                  </div>
                  <div class="mb-2">
                    <select id="rulesProductFilter" class="form-select form-select-sm">
                      <option value="">All products</option>
                    </select>
                  </div>
                  <ul class="rules-list list-unstyled mb-0" id="rulesList">
                    <!-- JS inserts rules -->
                  </ul>
                </div>

                <!-- FEEDBACK -->
                <div class="tab-pane fade" id="pane-feedback" role="tabpanel" aria-labelledby="tab-feedback">
                  <h6 class="mb-2">What do you think about our shop?</h6>
                  <form id="feedbackForm" class="mb-3">
                    <div class="mb-2">
                      <textarea id="feedbackText" class="form-control form-control-sm" rows="2" placeholder="Your feedback..." required></textarea>
                    </div>
                    <div class="mb-2">
                      <label class="form-label small mb-1">Attach image (optional)</label>
                      <input id="feedbackImage" type="file" accept="image/*" class="form-control form-control-sm">
                    </div>
                    <button type="submit" class="btn btn-sm btn-primary">
                      Submit Feedback
                    </button>
                  </form>

                  <h6 class="mb-2">Latest feedback</h6>
                  <div id="feedbackList" class="small">
                    <!-- JS renders feedback -->
                  </div>
                </div>

                <!-- MY ORDERS -->
                <div class="tab-pane fade" id="pane-orders" role="tabpanel" aria-labelledby="tab-orders">
                  <div id="ordersGuestNotice" class="small-muted">
                    Login to view your orders and payment status.
                  </div>
                  <div id="ordersList" class="mt-1">
                    <!-- JS renders orders -->
                  </div>
                </div>

                <!-- DELIVERED ACCOUNTS -->
                <div class="tab-pane fade" id="pane-delivered" role="tabpanel" aria-labelledby="tab-delivered">
                  <div id="deliveredGuestNotice" class="small-muted">
                    Login to see delivered accounts (email, password, profile, pin).
                  </div>
                  <div id="deliveredList" class="mt-1">
                    <!-- JS renders delivered accounts -->
                  </div>
                </div>
              </div>
            </div>
          </div>

          <p class="small-muted text-center">
            Payments are manually confirmed by admin. You'll be notified inside the site when status becomes <strong>Delivered</strong>.
          </p>
        </div>
      </div>
    </div>
  </main>

  <!-- LOGIN / SIGNUP MODAL -->
  <div class="modal fade" id="authModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="authModalTitle">Login</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="authForm">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input id="authEmail" type="email" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input id="authPassword" type="password" class="form-control" required>
            </div>
            <button id="authSubmitBtn" type="submit" class="btn btn-primary w-100">
              Login
            </button>
          </form>
          <p class="mt-3 small text-center">
            <span id="authSwitchText">Don't have an account?</span>
            <button id="authSwitchBtn" class="btn btn-link btn-sm p-0 align-baseline">Sign up</button>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- PRODUCT / CHECKOUT MODAL -->
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productModalTitle">Product</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <h6>Choose combo</h6>
              <div class="mb-2">
                <label class="form-label small">Account type</label>
                <select id="comboAccountType" class="form-select form-select-sm">
                  <option value="">Select type</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label small">Duration</label>
                <select id="comboDuration" class="form-select form-select-sm">
                  <option value="">Select duration</option>
                </select>
              </div>
              <p class="mb-1">
                <span class="small-muted">Price: </span>
                <span class="product-price-pill" id="comboPriceLabel">‚Ç±0.00</span>
              </p>
              <p class="mb-0">
                <span class="small-muted">Available slots: </span>
                <span class="product-stock-pill" id="comboStockLabel">
                  <i class="fa fa-circle-notch fa-spin me-1"></i>Checking...
                </span>
              </p>
              <p class="small-muted mt-2 mb-0">
                If 0 slots, you can't place an order for this combo.
              </p>
            </div>
            <div class="col-md-6">
              <h6>Payment details</h6>
              <p class="small-muted">
                After sending payment, fill-out details and upload proof. Admin will confirm manually.
              </p>
              <div class="mb-2">
                <label class="form-label small">Payment method</label>
                <select id="payMethod" class="form-select form-select-sm">
                  <option value="">Select</option>
                  <option value="GCash">GCash</option>
                  <option value="Maya">Maya</option>
                  <option value="Bank transfer">Bank transfer</option>
                  <option value="Others">Others</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label small">Reference number</label>
                <input id="payRef" class="form-control form-control-sm" placeholder="e.g. GCash ref #">
              </div>
              <div class="mb-2">
                <label class="form-label small">Proof of payment (screenshot)</label>
                <input id="payProof" type="file" accept="image/*" class="form-control form-control-sm">
                <div class="small-muted mt-1">Image will be stored as Base64 string.</div>
              </div>
              <div class="alert alert-warning py-2 px-3 small mt-2" id="productLoginNotice">
                You must login before placing an order.
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="btnPlaceOrder" type="button" class="btn btn-primary">
            Place Order
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- REPORT ISSUE MODAL -->
  <div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Report an Issue</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="reportForm">
            <input type="hidden" id="reportOrderId">
            <div class="mb-2">
              <label class="form-label small">Order ID</label>
              <input id="reportOrderDisplay" class="form-control form-control-sm" readonly>
            </div>
            <div class="mb-3">
              <label class="form-label small">Issue / concern</label>
              <textarea id="reportText" class="form-control" rows="3" required></textarea>
            </div>
            <button type="submit" class="btn btn-primary w-100">
              Submit Report
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========= CONFIG =========
    const SUPABASE_URL = "https://hnymqvkfmythdxtjqeam.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhueW1xdmtmbXl0aGR4dGpxZWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjE3NTUsImV4cCI6MjA3ODY5Nzc1NX0.4ww5fKNnbhNzNrkJZLa466b6BsKE_yYMO2YH6-auFlI";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Optional Telegram (fill if you want real notifs)
    const TELEGRAM_BOT_TOKEN = "";
    const TELEGRAM_CHAT_ID = "";

    let CURRENT_USER = null;
    let ALL_PRODUCTS = [];
    let ALL_STOCKS = [];
    let PRICE_ROWS = [];
    let CURRENT_PRODUCT = null;
    let CURRENT_COMBO = null;
    let CURRENT_PROOF_BASE64 = null;
    let AUTH_MODE = "login"; // or "signup"

    // ========= UTILS =========
    function showToast(message, type = "info") {
      const container = document.getElementById("toastContainer");
      if (!container) return;

      const wrapper = document.createElement("div");
      const bsType =
        type === "success"
          ? "success"
          : type === "danger" || type === "error"
          ? "danger"
          : type === "warning"
          ? "warning"
          : "secondary";

      wrapper.className = `toast align-items-center text-bg-${bsType} border-0`;
      wrapper.role = "alert";
      wrapper.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      container.appendChild(wrapper);
      const t = new bootstrap.Toast(wrapper);
      t.show();
      wrapper.addEventListener("hidden.bs.toast", () => wrapper.remove());
    }

    function safeNumber(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function initialsFromEmail(email) {
      if (!email) return "?";
      const name = email.split("@")[0] || "";
      if (!name) return "?";
      return name[0].toUpperCase();
    }

    async function fileToBase64(file) {
      if (!file) return null;
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function sendTelegramNotification(order) {
      if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) return;
      try {
        const text =
          `üõí New order #${order.id}\n` +
          `Buyer: ${order.buyer_email || order.buyer_id}\n` +
          `Product: ${order.product_id} (${order.account_type} / ${order.duration})\n` +
          `Price: ‚Ç±${safeNumber(order.price).toFixed(2)}\n` +
          `Payment: ${order.payment_method} | Ref: ${order.reference_number || "-"}`;
        await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text,
          }),
        });
      } catch (err) {
        console.warn("Telegram notify failed:", err);
      }
    }

    // ========= AUTH =========
    async function refreshUser() {
      const { data } = await supabase.auth.getUser();
      CURRENT_USER = data.user || null;

      const emailLabel = document.getElementById("userEmailLabel");
      const btnLoginOpen = document.getElementById("btnLoginOpen");
      const btnLogout = document.getElementById("btnLogout");
      const buyerAvatar = document.getElementById("buyerAvatar");
      const buyerGreeting = document.getElementById("buyerGreeting");
      const buyerStatusText = document.getElementById("buyerStatusText");

      if (CURRENT_USER) {
        const email = CURRENT_USER.email;
        emailLabel.textContent = email;
        btnLoginOpen.classList.add("d-none");
        btnLogout.classList.remove("d-none");
        buyerAvatar.textContent = initialsFromEmail(email);
        buyerGreeting.textContent = "Hi, " + (email.split("@")[0] || "User");
        buyerStatusText.textContent = "You can now place orders and view your accounts.";
        document.getElementById("ordersGuestNotice").classList.add("d-none");
        document.getElementById("deliveredGuestNotice").classList.add("d-none");
        loadMyOrders();
        loadDeliveredAccounts();
      } else {
        emailLabel.textContent = "";
        btnLoginOpen.classList.remove("d-none");
        btnLogout.classList.add("d-none");
        buyerAvatar.textContent = "?";
        buyerGreeting.textContent = "Welcome, Guest";
        buyerStatusText.textContent = "Login to track your orders and delivered accounts.";
        document.getElementById("ordersGuestNotice").classList.remove("d-none");
        document.getElementById("deliveredGuestNotice").classList.remove("d-none");
        document.getElementById("ordersList").innerHTML = "";
        document.getElementById("deliveredList").innerHTML = "";
      }
    }

    async function handleAuthSubmit(e) {
      e.preventDefault();
      const email = document.getElementById("authEmail").value.trim();
      const password = document.getElementById("authPassword").value;

      if (!email || !password) {
        showToast("Please fill email and password.", "warning");
        return;
      }

      try {
        if (AUTH_MODE === "login") {
          const { error } = await supabase.auth.signInWithPassword({ email, password });
          if (error) throw error;
          showToast("Logged in successfully.", "success");
        } else {
          const { error } = await supabase.auth.signUp({ email, password });
          if (error) throw error;
          showToast("Account created and logged in.", "success");
        }
        await refreshUser();
        bootstrap.Modal.getInstance(document.getElementById("authModal")).hide();
      } catch (err) {
        console.error("[auth] error:", err);
        showToast(err.message || "Authentication failed.", "danger");
      }
    }

    async function handleLogout() {
      try {
        await supabase.auth.signOut();
        showToast("Logged out.", "success");
        await refreshUser();
      } catch (err) {
        console.error("[logout] error:", err);
      }
    }

    function openAuthModal(mode = "login") {
      AUTH_MODE = mode;
      const title = document.getElementById("authModalTitle");
      const submitBtn = document.getElementById("authSubmitBtn");
      const switchText = document.getElementById("authSwitchText");
      const switchBtn = document.getElementById("authSwitchBtn");
      document.getElementById("authForm").reset();

      if (mode === "login") {
        title.textContent = "Login";
        submitBtn.textContent = "Login";
        switchText.textContent = "Don't have an account?";
        switchBtn.textContent = "Sign up";
      } else {
        title.textContent = "Sign up";
        submitBtn.textContent = "Sign up";
        switchText.textContent = "Already have an account?";
        switchBtn.textContent = "Login";
      }

      const modal = new bootstrap.Modal(document.getElementById("authModal"));
      modal.show();
    }

    // ========= PRODUCTS / STOCKS / PRICES =========
    async function loadInitialData() {
      try {
        const [
          { data: products, error: prodErr },
          { data: stocks, error: stockErr },
        ] = await Promise.all([
          supabase.from("products").select("id, name, category, icon").order("name", { ascending: true }),
          supabase.from("stocks").select("product_id, account_type, duration, status, quantity"),
        ]);

        if (prodErr) throw prodErr;
        if (stockErr) throw stockErr;

        ALL_PRODUCTS = products || [];
        ALL_STOCKS = stocks || [];

        // fetch pricing from product_prices if exists
        try {
          const { data: prices, error: priceErr } = await supabase
            .from("product_prices")
            .select("product_id, account_type, duration, price");
          if (!priceErr) {
            PRICE_ROWS = prices || [];
          } else {
            PRICE_ROWS = [];
          }
        } catch (e) {
          PRICE_ROWS = [];
        }

        renderProducts();
        populateRulesProductFilter();
        loadRules();
      } catch (err) {
        console.error("[loadInitialData] error:", err);
        showToast("Failed to load products.", "danger");
      }
    }

    function stockCountByProduct(productId) {
      let total = 0;
      (ALL_STOCKS || []).forEach((s) => {
        if (
          s.product_id === productId &&
          (s.status || "").toLowerCase() === "available" &&
          safeNumber(s.quantity) > 0
        ) {
          total += safeNumber(s.quantity);
        }
      });
      return total;
    }

    function stockCountByCombo(productId, accountType, duration) {
      let total = 0;
      (ALL_STOCKS || []).forEach((s) => {
        if (
          s.product_id === productId &&
          s.account_type === accountType &&
          s.duration === duration &&
          (s.status || "").toLowerCase() === "available" &&
          safeNumber(s.quantity) > 0
        ) {
          total += safeNumber(s.quantity);
        }
      });
      return total;
    }

    function renderProducts(categoryFilter = "all") {
      const row = document.getElementById("productsRow");
      row.innerHTML = "";

      if (!ALL_PRODUCTS.length) {
        row.innerHTML = `<div class="col-12"><div class="alert alert-light">No products yet.</div></div>`;
        return;
      }

      ALL_PRODUCTS.forEach((p) => {
        const category = (p.category || "").toLowerCase();
        if (categoryFilter !== "all" && category !== categoryFilter) return;

        const col = document.createElement("div");
        col.className = "col-6 col-md-4 mb-3";

        const stock = stockCountByProduct(p.id);
        const icon = p.icon || "‚≠ê";

        col.innerHTML = `
          <div class="card product-card h-100">
            <div class="card-body d-flex flex-column">
              <div class="product-img mb-2">${icon}</div>
              <h6 class="card-title mb-1">${p.name}</h6>
              <p class="small-muted mb-2 text-capitalize">${p.category || "-"}</p>
              <p class="mb-2">
                <span class="product-stock-pill">
                  <i class="fa fa-database"></i>
                  ${stock} slot(s)
                </span>
              </p>
              <div class="mt-auto">
                <button class="btn btn-sm btn-primary w-100 btn-open-product" data-id="${p.id}">
                  View combos / Buy
                </button>
              </div>
            </div>
          </div>
        `;

        row.appendChild(col);
      });

      // Attach handlers
      document.querySelectorAll(".btn-open-product").forEach((btn) => {
        btn.addEventListener("click", () => {
          const productId = btn.getAttribute("data-id");
          const product = ALL_PRODUCTS.find((x) => x.id === productId);
          if (!product) return;
          openProductModal(product);
        });
      });
    }

    function populateRulesProductFilter() {
      const select = document.getElementById("rulesProductFilter");
      if (!select) return;
      select.innerHTML = `<option value="">All products</option>`;
      ALL_PRODUCTS.forEach((p) => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        select.appendChild(opt);
      });
    }

    function openProductModal(product) {
      CURRENT_PRODUCT = product;
      CURRENT_COMBO = null;
      CURRENT_PROOF_BASE64 = null;
      document.getElementById("productModalTitle").textContent = product.name;

      const accountTypeSelect = document.getElementById("comboAccountType");
      const durationSelect = document.getElementById("comboDuration");
      const priceLabel = document.getElementById("comboPriceLabel");
      const stockLabel = document.getElementById("comboStockLabel");

      accountTypeSelect.innerHTML = `<option value="">Select type</option>`;
      durationSelect.innerHTML = `<option value="">Select duration</option>`;
      priceLabel.textContent = "‚Ç±0.00";
      stockLabel.innerHTML = `<i class="fa fa-circle-notch fa-spin me-1"></i>Checking...`;

      // filter price rows for this product
      const combos = (PRICE_ROWS || []).filter((row) => row.product_id === product.id);

      const typeSet = new Set();
      combos.forEach((c) => {
        if (c.account_type) typeSet.add(c.account_type);
      });

      if (!combos.length) {
        stockLabel.textContent = "0 (no pricing rows)";
      }

      typeSet.forEach((t) => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        accountTypeSelect.appendChild(opt);
      });

      durationSelect.disabled = true;

      if (CURRENT_USER) {
        document.getElementById("productLoginNotice").classList.add("d-none");
      } else {
        document.getElementById("productLoginNotice").classList.remove("d-none");
      }

      // on type change
      accountTypeSelect.onchange = () => {
        const atype = accountTypeSelect.value;
        durationSelect.innerHTML = `<option value="">Select duration</option>`;
        durationSelect.disabled = true;
        priceLabel.textContent = "‚Ç±0.00";
        stockLabel.textContent = "Select duration";

        if (!atype) return;
        const filtered = combos.filter((c) => c.account_type === atype);
        const durationSet = new Set();
        filtered.forEach((c) => {
          if (c.duration) durationSet.add(c.duration);
        });
        durationSet.forEach((d) => {
          const opt = document.createElement("option");
          opt.value = d;
          opt.textContent = d;
          durationSelect.appendChild(opt);
        });
        durationSelect.disabled = false;
      };

      // on duration change
      durationSelect.onchange = () => {
        const atype = accountTypeSelect.value;
        const dur = durationSelect.value;
        if (!atype || !dur) {
          priceLabel.textContent = "‚Ç±0.00";
          stockLabel.textContent = "Select combo";
          CURRENT_COMBO = null;
          return;
        }
        const combo = (PRICE_ROWS || []).find(
          (c) =>
            c.product_id === product.id &&
            c.account_type === atype &&
            c.duration === dur
        );
        CURRENT_COMBO = combo || null;
        const priceVal = combo?.price || 0;
        priceLabel.textContent = "‚Ç±" + safeNumber(priceVal).toFixed(2);
        const available = stockCountByCombo(product.id, atype, dur);
        stockLabel.textContent = `${available} slot(s)`;
      };

      // proof file
      document.getElementById("payProof").value = "";
      CURRENT_PROOF_BASE64 = null;

      const modal = new bootstrap.Modal(document.getElementById("productModal"));
      modal.show();
    }

    async function handlePlaceOrder() {
      if (!CURRENT_USER) {
        showToast("Please login first before placing an order.", "warning");
        openAuthModal("login");
        return;
      }
      if (!CURRENT_PRODUCT) {
        showToast("No product is selected.", "warning");
        return;
      }

      const accountType = document.getElementById("comboAccountType").value;
      const duration = document.getElementById("comboDuration").value;
      const payMethod = document.getElementById("payMethod").value;
      const payRef = document.getElementById("payRef").value.trim();

      if (!accountType || !duration) {
        showToast("Please choose account type and duration.", "warning");
        return;
      }

      const available = stockCountByCombo(CURRENT_PRODUCT.id, accountType, duration);
      if (available <= 0) {
        showToast("No available slots for this combo.", "warning");
        return;
      }

      if (!payMethod) {
        showToast("Please select payment method.", "warning");
        return;
      }

      const priceVal = CURRENT_COMBO?.price || 0;

      // read proof if not yet
      if (!CURRENT_PROOF_BASE64) {
        const fileInput = document.getElementById("payProof");
        if (fileInput.files && fileInput.files[0]) {
          try {
            CURRENT_PROOF_BASE64 = await fileToBase64(fileInput.files[0]);
          } catch (err) {
            console.warn("Base64 failed:", err);
          }
        }
      }

      try {
        const payload = {
          buyer_id: CURRENT_USER.id,
          buyer_email: CURRENT_USER.email,
          product_id: CURRENT_PRODUCT.id,
          account_type: accountType,
          duration,
          price: priceVal,
          status: "pending",
          payment_method: payMethod,
          reference_number: payRef || null,
          proof_image_url: CURRENT_PROOF_BASE64 || null,
          created_at: new Date().toISOString(),
        };
        const { data, error } = await supabase.from("orders").insert(payload).select("id").single();
        if (error) throw error;

        showToast("Order placed. Wait for admin to confirm payment.", "success");
        bootstrap.Modal.getInstance(document.getElementById("productModal")).hide();
        document.getElementById("payMethod").value = "";
        document.getElementById("payRef").value = "";
        document.getElementById("payProof").value = "";

        await loadMyOrders();
        await sendTelegramNotification({ ...payload, id: data.id });
      } catch (err) {
        console.error("[placeOrder] error:", err);
        showToast("Failed to place order: " + (err.message || ""), "danger");
      }
    }

    // ========= RULES =========
    async function loadRules() {
      const list = document.getElementById("rulesList");
      list.innerHTML = `<li class="small-muted">Loading rules...</li>`;

      try {
        const { data, error } = await supabase
          .from("rules")
          .select("id, rule_text, product_id")
          .order("id", { ascending: true });
        if (error) throw error;

        list.innerHTML = "";
        if (!data || !data.length) {
          list.innerHTML = `<li class="small-muted">No rules set yet.</li>`;
          return;
        }

        const searchTerm = (document.getElementById("rulesSearchInput").value || "").toLowerCase();
        const productFilter = document.getElementById("rulesProductFilter").value;

        data.forEach((r) => {
          if (productFilter && r.product_id !== productFilter) return;
          if (searchTerm && !r.rule_text.toLowerCase().includes(searchTerm)) return;

          const li = document.createElement("li");
          li.innerHTML = `
            ${r.product_id ? `<strong>[${r.product_id}]</strong> ` : ""}${r.rule_text}
          `;
          list.appendChild(li);
        });

        if (!list.children.length) {
          list.innerHTML = `<li class="small-muted">No matching rules.</li>`;
        }
      } catch (err) {
        console.error("[loadRules] error:", err);
        list.innerHTML = `<li class="small text-danger">Failed to load rules.</li>`;
      }
    }

    // ========= FEEDBACK =========
    async function loadFeedback() {
      const container = document.getElementById("feedbackList");
      container.innerHTML = `<div class="small-muted">Loading...</div>`;
      try {
        const { data, error } = await supabase
          .from("feedback")
          .select("id, buyer_id, buyer_email, message, image_url, created_at")
          .order("created_at", { ascending: false })
          .limit(15);
        if (error) throw error;

        container.innerHTML = "";
        if (!data || !data.length) {
          container.innerHTML = `<div class="small-muted">No feedback yet.</div>`;
          return;
        }

        data.forEach((f) => {
          const div = document.createElement("div");
          div.className = "mb-2 pb-2 border-bottom";
          const email = f.buyer_email || "Guest";
          div.innerHTML = `
            <div class="fw-semibold small">${email}</div>
            <div>${f.message}</div>
            ${
              f.image_url
                ? `<div class="mt-1"><a href="${f.image_url}" target="_blank" class="small">View image</a></div>`
                : ""
            }
            <div class="small-muted mt-1">${f.created_at || ""}</div>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error("[loadFeedback] error:", err);
        container.innerHTML = `<div class="small text-danger">Failed to load feedback.</div>`;
      }
    }

    async function handleFeedbackSubmit(e) {
      e.preventDefault();
      const text = document.getElementById("feedbackText").value.trim();
      const fileInput = document.getElementById("feedbackImage");

      if (!text) {
        showToast("Please write some feedback.", "warning");
        return;
      }

      let imageBase64 = null;
      if (fileInput.files && fileInput.files[0]) {
        try {
          imageBase64 = await fileToBase64(fileInput.files[0]);
        } catch (err) {
          console.warn("feedback base64 failed:", err);
        }
      }

      try {
        const payload = {
          buyer_id: CURRENT_USER?.id || null,
          buyer_email: CURRENT_USER?.email || null,
          message: text,
          image_url: imageBase64,
          created_at: new Date().toISOString(),
        };
        const { error } = await supabase.from("feedback").insert(payload);
        if (error) throw error;
        showToast("Thank you for your feedback!", "success");
        document.getElementById("feedbackForm").reset();
        await loadFeedback();
      } catch (err) {
        console.error("[feedbackSubmit] error:", err);
        showToast("Failed to send feedback.", "danger");
      }
    }

    // ========= ORDERS =========
    async function loadMyOrders() {
      if (!CURRENT_USER) return;
      const container = document.getElementById("ordersList");
      container.innerHTML = `<div class="small-muted">Loading...</div>`;

      try {
        const { data, error } = await supabase
          .from("orders")
          .select("id, product_id, account_type, duration, price, status, payment_method, reference_number, created_at")
          .eq("buyer_id", CURRENT_USER.id)
          .order("created_at", { ascending: false });
        if (error) throw error;

        container.innerHTML = "";
        if (!data || !data.length) {
          container.innerHTML = `<div class="small-muted">You have no orders yet.</div>`;
          return;
        }

        data.forEach((o) => {
          const div = document.createElement("div");
          div.className = "border rounded p-2 mb-2";

          const statusClass =
            (o.status || "").toLowerCase() === "pending"
              ? "status-pending"
              : (o.status || "").toLowerCase() === "delivered"
              ? "status-delivered"
              : (o.status || "").toLowerCase() === "confirmed"
              ? "status-confirmed"
              : "status-cancelled";

          div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div class="small fw-semibold">Order #${o.id}</div>
              <span class="order-status ${statusClass}">${o.status || "?"}</span>
            </div>
            <div class="small">
              ${o.product_id} ‚Äì ${o.account_type || "?"} / ${o.duration || "?"}
            </div>
            <div class="small-muted">
              Price: ‚Ç±${safeNumber(o.price).toFixed(2)}<br>
              Payment: ${o.payment_method || "-"} | Ref: ${o.reference_number || "-"}
            </div>
            <div class="small-muted mt-1">${o.created_at || ""}</div>
            <div class="mt-2 d-flex justify-content-end gap-2">
              <button class="btn btn-xs btn-sm btn-outline-secondary btn-report-order" data-id="${o.id}">
                Report issue
              </button>
            </div>
          `;
          container.appendChild(div);
        });

        container.querySelectorAll(".btn-report-order").forEach((btn) => {
          btn.addEventListener("click", () => {
            const orderId = btn.getAttribute("data-id");
            openReportModal(orderId);
          });
        });
      } catch (err) {
        console.error("[loadMyOrders] error:", err);
        container.innerHTML = `<div class="small text-danger">Failed to load orders.</div>`;
      }
    }

    // ========= DELIVERED ACCOUNTS =========
    async function loadDeliveredAccounts() {
      if (!CURRENT_USER) return;
      const container = document.getElementById("deliveredList");
      container.innerHTML = `<div class="small-muted">Loading...</div>`;

      try {
        const { data, error } = await supabase
          .from("records")
          .select("id, order_id, product_id, account_type, duration, purchase_date, account_email, account_password, profile, pin")
          .eq("buyer", CURRENT_USER.email)
          .order("purchase_date", { ascending: false });
        if (error) throw error;

        container.innerHTML = "";
        if (!data || !data.length) {
          container.innerHTML = `<div class="small-muted">No delivered accounts yet.</div>`;
          return;
        }

        data.forEach((r) => {
          const div = document.createElement("div");
          div.className = "border rounded p-2 mb-2 small";
          div.innerHTML = `
            <div class="d-flex justify-content-between mb-1">
              <div><strong>${r.product_id}</strong> ‚Äì ${r.account_type || "?"} / ${r.duration || "?"}</div>
              <div class="small-muted">Order #${r.order_id || "-"}</div>
            </div>
            <div>
              <div>Email: <code>${r.account_email || "-"}</code></div>
              <div>Password: <code>${r.account_password || "-"}</code></div>
              <div>Profile: <code>${r.profile || "-"}</code></div>
              <div>PIN: <code>${r.pin || "-"}</code></div>
            </div>
            <div class="small-muted mt-1">Delivered: ${r.purchase_date || ""}</div>
          `;
          container.appendChild(div);
        });
      } catch (err) {
        console.error("[loadDeliveredAccounts] error:", err);
        container.innerHTML = `<div class="small text-danger">Failed to load delivered accounts.</div>`;
      }
    }

    // ========= REPORT ISSUE =========
    function openReportModal(orderId) {
      if (!CURRENT_USER) {
        showToast("Please login first.", "warning");
        openAuthModal("login");
        return;
      }
      document.getElementById("reportOrderId").value = orderId;
      document.getElementById("reportOrderDisplay").value = orderId;
      document.getElementById("reportText").value = "";
      const m = new bootstrap.Modal(document.getElementById("reportModal"));
      m.show();
    }

    async function handleReportSubmit(e) {
      e.preventDefault();
      if (!CURRENT_USER) {
        showToast("Please login first.", "warning");
        return;
      }
      const orderId = document.getElementById("reportOrderId").value;
      const text = document.getElementById("reportText").value.trim();
      if (!text) {
        showToast("Please describe the issue.", "warning");
        return;
      }

      try {
        const payload = {
          order_id: orderId,
          buyer_id: CURRENT_USER.id,
          issue_description: text,
          status: "open",
          created_at: new Date().toISOString(),
        };
        const { error } = await supabase.from("reports").insert(payload);
        if (error) throw error;
        showToast("Report submitted. We will review it.", "success");
        bootstrap.Modal.getInstance(document.getElementById("reportModal")).hide();
      } catch (err) {
        console.error("[reportSubmit] error:", err);
        showToast("Failed to submit report.", "danger");
      }
    }

    // ========= CATEGORY TABS =========
    function initCategoryTabs() {
      document.querySelectorAll(".category-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          const cat = tab.getAttribute("data-category");
          document.querySelectorAll(".category-tab").forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          renderProducts(cat);
        });
      });
    }

    // ========= INIT =========
    document.addEventListener("DOMContentLoaded", async () => {
      initCategoryTabs();

      // Auth buttons
      document.getElementById("btnLoginOpen").addEventListener("click", () => openAuthModal("login"));
      document.getElementById("btnLogout").addEventListener("click", handleLogout);
      document.getElementById("authForm").addEventListener("submit", handleAuthSubmit);
      document.getElementById("authSwitchBtn").addEventListener("click", () => {
        openAuthModal(AUTH_MODE === "login" ? "signup" : "login");
      });

      // Product / checkout
      document.getElementById("btnPlaceOrder").addEventListener("click", handlePlaceOrder);
      document.getElementById("payProof").addEventListener("change", async (e) => {
        if (e.target.files && e.target.files[0]) {
          try {
            CURRENT_PROOF_BASE64 = await fileToBase64(e.target.files[0]);
          } catch (err) {
            console.warn("Proof base64 failed:", err);
          }
        }
      });

      // Rules events
      document.getElementById("rulesSearchInput").addEventListener("input", loadRules);
      document.getElementById("rulesProductFilter").addEventListener("change", loadRules);

      // Feedback
      document.getElementById("feedbackForm").addEventListener("submit", handleFeedbackSubmit);

      // Report
      document.getElementById("reportForm").addEventListener("submit", handleReportSubmit);

      // Auth state
      supabase.auth.onAuthStateChange(async () => {
        await refreshUser();
      });

      await refreshUser();
      await loadInitialData();
      await loadFeedback();
    });
  </script>
</body>
</html>