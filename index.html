<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Aiaxcart Premium Shop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { --primary: #ffb0b5; --secondary: #ffd3d6; --accent: #f9dcc0; --light: #fefaf7; --dark: #382f2c; --text-muted: #7a6963; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Segoe UI", sans-serif; background: var(--light); color: var(--dark); }
    header { background: var(--secondary); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); position: sticky; top: 0; z-index: 30; }
    .header-inner { max-width: 1100px; margin: 0 auto; padding: 0.9rem 1.25rem; display: flex; justify-content: space-between; align-items: center; }
    .logo { display: flex; gap: 0.4rem; align-items: center; font-weight: 700; font-size: 1.4rem; }
    .top-nav a { text-decoration: none; margin-left: 0.7rem; padding: 0.35rem 1.1rem; border-radius: 999px; color: var(--dark); font-weight: 500; background: #ffeef0; }
    .top-nav a.active { background: var(--primary); color: #fff; }
    main { max-width: 1100px; margin: 1.5rem auto 2.5rem; padding: 0 1.25rem; }
    .hero { background: #fff; border-radius: 18px; padding: 1.4rem; margin-bottom: 1rem; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.06); display: flex; justify-content: space-between; flex-wrap: wrap; }
    .category-row { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.6rem; margin-bottom: 0.5rem; }
    .category-pill { flex-shrink: 0; padding: 0.35rem 0.95rem; border-radius: 999px; border: 1px solid #ffdfe3; background: #fff; cursor: pointer; color: var(--text-muted); }
    .category-pill.active { background: var(--primary); border-color: var(--primary); color: #fff; }
    .products-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    @media (max-width: 900px) { .products-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px) { .products-grid { grid-template-columns: 1fr; } }
    .product-card { background: #fff; border-radius: 16px; padding: 1rem; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05); display: flex; flex-direction: column; gap: 0.35rem; }
    .product-icon { width: 40px; height: 40px; border-radius: 12px; background: #ffeef0; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; }
    .buyer-panel { background: #fff; border-radius: 18px; box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05); padding: 1.1rem; }
    .buyer-header { display: flex; align-items: center; gap: 0.9rem; margin-bottom: 0.8rem; }
    .buyer-avatar { width: 52px; height: 52px; border-radius: 50%; background: var(--secondary); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 700; }
    .buyer-tabs .nav-link { border-radius: 999px; padding: 0.3rem 0.9rem; color: var(--text-muted); }
    .buyer-tabs .nav-link.active { background: var(--primary); color: #fff; }
    .order-status-pill { padding: 0.2rem 0.6rem; border-radius: 999px; font-size: 0.72rem; font-weight: 600; }
    .os-pending { background: #fff3cd; color: #856404; }
    .os-delivered { background: #d4edda; color: #155724; }
    .hidden { display: none !important; }
  </style>
</head>

<body>
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <header>
    <div class="header-inner">
      <div class="logo"><span>üõí</span><span>Aiaxcart Premium Shop</span></div>
      <nav class="top-nav">
        <a href="./index.html" class="active">Home</a>
        <a href="./admin.html">Admin</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="hero">
      <div><h1>Premium accounts, hassle-free.</h1><p>Select app, pay, upload proof. Automated delivery.</p></div>
      <div class="hero-right">
        <button id="btnOpenLogin" class="btn btn-outline-dark btn-sm" type="button"><i class="fa fa-user"></i> Login / Sign up</button>
      </div>
    </section>

    <section>
      <div class="category-row" id="categoryRow">
        <button class="category-pill active" data-cat="all">All</button>
        <button class="category-pill" data-cat="entertainment">Entertainment</button>
        <button class="category-pill" data-cat="streaming">Streaming</button>
        <button class="category-pill" data-cat="educational">Educational</button>
        <button class="category-pill" data-cat="editing">Editing</button>
        <button class="category-pill" data-cat="ai">AI</button>
      </div>
      <div id="productsGrid" class="products-grid"></div>
    </section>

    <section class="buyer-panel">
      <div class="buyer-header">
        <div class="buyer-avatar" id="buyerAvatar">?</div>
        <div class="buyer-meta">
          <div id="buyerWelcome">Welcome, Guest</div>
          <small id="buyerSubtext">Login to track orders.</small>
        </div>
        <div class="ms-auto d-flex gap-2">
          <button id="btnBuyerLogoutHeader" class="btn btn-sm btn-outline-secondary hidden">Logout</button>
        </div>
      </div>

      <ul class="nav nav-pills buyer-tabs" id="buyerTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#pane-rules">Rules</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-feedback">Feedback</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-orders">My Orders</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pane-delivered">Delivered Accounts</button></li>
      </ul>

      <div class="tab-content buyer-tab-pane mt-3">
        <div class="tab-pane fade show active" id="pane-rules">
          <ul id="rulesList" class="list-group list-group-flush small"></ul>
        </div>

        <div class="tab-pane fade" id="pane-feedback">
          <form id="feedbackForm" class="mb-3 small">
            <textarea id="feedbackMessage" class="form-control form-control-sm mb-2" placeholder="Message" required></textarea>
            <select id="feedbackRating" class="form-select form-select-sm mb-2"><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê</option></select>
            <button class="btn btn-primary btn-sm">Submit</button>
          </form>
          <ul id="feedbackList" class="list-group list-group-flush small"></ul>
        </div>

        <div class="tab-pane fade" id="pane-orders">
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light"><tr><th>Product</th><th>Price</th><th>Status</th><th>Ref</th><th>Action</th></tr></thead>
              <tbody id="ordersTableBody"><tr><td colspan="5">Login to see orders.</td></tr></tbody>
            </table>
          </div>
        </div>

        <div class="tab-pane fade" id="pane-delivered">
          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
              <thead class="table-light"><tr><th>Product</th><th>Email</th><th>Pass</th><th>Profile</th><th>Expiry</th></tr></thead>
              <tbody id="deliveredTableBody"><tr><td colspan="5">Login to see accounts.</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 id="pmTitle" class="modal-title">Product</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-7">
              <h6>Choose combo</h6>
              <select id="pmAccountType" class="form-select form-select-sm mb-2"><option value="">Select type</option></select>
              <select id="pmDuration" class="form-select form-select-sm mb-2" disabled><option value="">Select duration</option></select>
              <div class="small mb-2">Price: <span id="pmPrice" class="text-danger fw-bold">‚Ç±0.00</span></div>
              <div id="pmStockDisplay" class="badge bg-secondary">Check stock...</div>
            </div>
            <div class="col-md-5">
              <h6>Payment details</h6>
              <div class="border rounded p-2 mb-2 small">
                <div><strong>GCash:</strong> 09XXXXXXXXX</div>
                <div><strong>Maya:</strong> 09XXXXXXXXX</div>
              </div>
              <input id="pmRefNumber" class="form-control form-control-sm mb-2" placeholder="Ref Number (Required)">
              <input id="pmProof" type="file" class="form-control form-control-sm">
            </div>
          </div>
        </div>
        <div class="modal-footer"><button id="pmPlaceOrder" class="btn btn-primary btn-sm">Place order</button></div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="authModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Login / Signup</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input id="loginEmail" type="email" class="form-control mb-2" placeholder="Email">
          <input id="loginPassword" type="password" class="form-control mb-2" placeholder="Password">
          <div class="d-grid gap-2">
            <button id="btnLoginBtn" class="btn btn-primary">Login</button>
            <button id="btnSignupBtn" class="btn btn-outline-secondary">Sign Up</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Report Issue</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <input type="hidden" id="reportOrderId">
          <textarea id="reportIssue" class="form-control" rows="3"></textarea>
          <button id="btnSubmitReport" class="btn btn-primary mt-2">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const SUPABASE_URL = "https://hnymqvkfmythdxtjqeam.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhueW1xdmtmbXl0aGR4dGpxZWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjE3NTUsImV4cCI6MjA3ODY5Nzc1NX0.4ww5fKNnbhNzNrkJZLa466b6BsKE_yYMO2YH6-auFlI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let allProducts = [];
    let pricingData = [];
    let currentProductForModal = null;

    function showToast(msg, type="info") {
      const box = document.getElementById("toastContainer");
      const el = document.createElement("div");
      el.className = `toast align-items-center text-bg-${type === 'danger' ? 'danger' : 'primary'} border-0`;
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      box.appendChild(el);
      new bootstrap.Toast(el).show();
    }

    async function refreshUser() {
      const { data } = await supabase.auth.getUser();
      currentUser = data.user;
      updateBuyerUI();
      if(currentUser) { loadMyOrders(); loadDelivered(); }
    }

    function updateBuyerUI() {
      const avatar = document.getElementById("buyerAvatar");
      const welcome = document.getElementById("buyerWelcome");
      const btnOpen = document.getElementById("btnOpenLogin");
      const btnLogout = document.getElementById("btnBuyerLogoutHeader");

      if (currentUser) {
        avatar.textContent = currentUser.email[0].toUpperCase();
        welcome.textContent = "Hi, " + currentUser.email;
        btnOpen.classList.add("hidden");
        btnLogout.classList.remove("hidden");
      } else {
        avatar.textContent = "?";
        welcome.textContent = "Welcome, Guest";
        btnOpen.classList.remove("hidden");
        btnLogout.classList.add("hidden");
      }
    }

    // AUTH
    document.getElementById("btnLoginBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) showToast(error.message, "danger");
      else { location.reload(); }
    });

    document.getElementById("btnSignupBtn").addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;
      const { error } = await supabase.auth.signUp({ email, password });
      if (error) showToast(error.message, "danger");
      else showToast("Account created! You are logged in.", "success");
    });

    document.getElementById("btnBuyerLogoutHeader").addEventListener("click", async () => {
      await supabase.auth.signOut(); location.reload();
    });
    document.getElementById("btnOpenLogin").addEventListener("click", () => new bootstrap.Modal(document.getElementById("authModal")).show());

    // PRODUCTS & PRICES
    async function loadData() {
      const [prodRes, priceRes] = await Promise.all([
        supabase.from("products").select("*"),
        supabase.from("product_prices").select("*")
      ]);
      allProducts = prodRes.data || [];
      pricingData = priceRes.data || [];
      renderProducts("all");
    }

    function renderProducts(cat) {
      const grid = document.getElementById("productsGrid"); grid.innerHTML = "";
      allProducts.forEach(p => {
        if (cat !== "all" && p.category !== cat) return;
        // Check if product has prices
        const hasPrice = pricingData.some(pr => pr.product_id === p.id);
        if(!hasPrice) return;

        const card = document.createElement("div"); card.className = "product-card";
        card.innerHTML = `
          <div class="d-flex align-items-center gap-2">
            <div class="product-icon">üé¨</div>
            <div><div class="fw-bold">${p.name}</div><small class="text-muted">${p.category}</small></div>
          </div>
          <button class="btn btn-primary btn-sm mt-2" onclick="openModal('${p.id}', '${p.name}')">Buy</button>
        `;
        grid.appendChild(card);
      });
    }

    document.querySelectorAll(".category-pill").forEach(pill => {
      pill.addEventListener("click", () => {
        document.querySelectorAll(".category-pill").forEach(p=>p.classList.remove("active"));
        pill.classList.add("active");
        renderProducts(pill.dataset.cat);
      });
    });

    // ORDER MODAL LOGIC
    function openModal(pid, name) {
      if(!currentUser) return showToast("Login first", "danger");
      currentProductForModal = pid;
      document.getElementById("pmTitle").textContent = name;
      
      // Filter types
      const types = [...new Set(pricingData.filter(x => x.product_id === pid).map(x => x.account_type))];
      const sel = document.getElementById("pmAccountType"); sel.innerHTML = "<option value=''>Select Type</option>";
      types.forEach(t => sel.innerHTML += `<option value="${t}">${t}</option>`);
      
      document.getElementById("pmDuration").innerHTML = "<option value=''>Select Duration</option>";
      document.getElementById("pmDuration").disabled = true;
      
      new bootstrap.Modal(document.getElementById("productModal")).show();
    }

    document.getElementById("pmAccountType").addEventListener("change", (e) => {
      const type = e.target.value;
      const sel = document.getElementById("pmDuration"); sel.innerHTML = "<option value=''>Select Duration</option>";
      if(!type) { sel.disabled=true; return; }
      sel.disabled=false;
      const rows = pricingData.filter(x => x.product_id === currentProductForModal && x.account_type === type);
      rows.forEach(r => sel.innerHTML += `<option value="${r.duration}" data-price="${r.price}">${r.duration}</option>`);
    });

    document.getElementById("pmDuration").addEventListener("change", async (e) => {
      const opt = e.target.options[e.target.selectedIndex];
      const price = opt.getAttribute("data-price");
      document.getElementById("pmPrice").textContent = "‚Ç±" + (price || "0.00");
      
      if(price) {
         const type = document.getElementById("pmAccountType").value;
         const { count } = await supabase.from("stocks").select("*", {count: 'exact'}).eq("product_id", currentProductForModal).eq("account_type", type).eq("duration", e.target.value).eq("status", "available");
         const badge = document.getElementById("pmStockDisplay");
         badge.textContent = count > 0 ? `${count} Slots Available` : "Out of Stock";
         badge.className = count > 0 ? "badge bg-success" : "badge bg-danger";
      }
    });

    document.getElementById("pmPlaceOrder").addEventListener("click", async () => {
      const type = document.getElementById("pmAccountType").value;
      const dur = document.getElementById("pmDuration").value;
      const ref = document.getElementById("pmRefNumber").value;
      const price = document.getElementById("pmPrice").textContent.replace("‚Ç±", "");
      const stockTxt = document.getElementById("pmStockDisplay").textContent;
      
      if(!type || !dur || !ref) return showToast("Fill all fields", "danger");
      if(stockTxt === "Out of Stock") return showToast("No stock available", "danger");

      // Image handling (Base64)
      const file = document.getElementById("pmProof").files[0];
      let imgUrl = null;
      if(file) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        await new Promise(resolve => reader.onload = () => { imgUrl = reader.result; resolve(); });
      }

      const { error } = await supabase.from("orders").insert({
        buyer_id: currentUser.id, buyer_email: currentUser.email,
        product_id: currentProductForModal, account_type: type, duration: dur,
        price: parseFloat(price), status: 'pending', payment_method: 'GCash/Maya',
        reference_number: ref, proof_image_url: imgUrl
      });

      if(error) showToast("Error: "+error.message, "danger");
      else {
        showToast("Order Placed!", "success");
        bootstrap.Modal.getInstance(document.getElementById("productModal")).hide();
        loadMyOrders();
      }
    });

    // TABS DATA
    async function loadMyOrders() {
      const { data } = await supabase.from("orders").select("*").eq("buyer_id", currentUser.id).order("created_at", {ascending: false});
      const tbody = document.getElementById("ordersTableBody"); tbody.innerHTML = data.length ? "" : "<tr><td colspan='5'>No orders.</td></tr>";
      data.forEach(o => {
        tbody.innerHTML += `<tr><td>${o.product_id}<br>${o.account_type}</td><td>‚Ç±${o.price}</td><td>${o.status}</td><td>${o.reference_number}</td><td><button class="btn btn-sm btn-warning" onclick="reportOrder('${o.id}')">Report</button></td></tr>`;
      });
    }
    async function loadDelivered() {
      const { data } = await supabase.from("records").select("*").eq("buyer", currentUser.email).order("created_at", {ascending: false});
      const tbody = document.getElementById("deliveredTableBody"); tbody.innerHTML = data.length ? "" : "<tr><td colspan='5'>No accounts.</td></tr>";
      data.forEach(r => {
        tbody.innerHTML += `<tr><td>${r.product_id}</td><td>${r.account_email}</td><td>${r.account_password}</td><td>${r.profile}</td><td>${r.expiry_date ? new Date(r.expiry_date).toLocaleDateString() : '-'}</td></tr>`;
      });
    }
    async function loadRules() {
      const { data } = await supabase.from("rules").select("*");
      const ul = document.getElementById("rulesList"); ul.innerHTML = "";
      data.forEach(r => ul.innerHTML += `<li class="list-group-item">${r.rule_text}</li>`);
    }
    
    // REPORT & FEEDBACK (Restored)
    window.reportOrder = (oid) => {
      document.getElementById("reportOrderId").value = oid;
      new bootstrap.Modal(document.getElementById("reportModal")).show();
    };
    document.getElementById("btnSubmitReport").addEventListener("click", async () => {
       const oid = document.getElementById("reportOrderId").value;
       const issue = document.getElementById("reportIssue").value;
       await supabase.from("reports").insert({ order_id: oid, buyer_id: currentUser.id, issue_description: issue, status: 'open' });
       showToast("Report Sent", "success");
    });
    
    // Init
    document.addEventListener("DOMContentLoaded", () => {
      refreshUser(); loadData(); loadRules();
    });
  </script>
</body>
</html>
