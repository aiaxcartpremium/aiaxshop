<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aiaxcart Premium Shop</title>

  <!-- CSS / Icons / Supabase -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #FFB0B5;
      --secondary: #FFD3D6;
      --dark: #382f2c;
      --light: #fefaf7;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--dark);
    }

    .navbar-brand {
      font-weight: 700;
      color: var(--primary);
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: none;
      transition: transform 0.2s;
      margin-bottom: 1.5rem;
      background: white;
    }

    .card:hover {
      transform: translateY(-5px);
    }

    .category-tab {
      cursor: pointer;
      padding: 10px 20px;
      border-radius: 30px;
      margin: 0 5px;
      transition: all 0.3s;
      font-weight: 500;
      background: white;
      white-space: nowrap;
    }

    .category-tab.active {
      background-color: var(--primary);
      color: white;
    }

    .product-card {
      height: 100%;
    }

    .product-img {
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      color: var(--primary);
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
    }

    .buyer-profile-img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.8rem;
      font-weight: bold;
      margin: 0 auto 15px;
    }

    .order-status {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status-confirmed {
      background-color: #d1ecf1;
      color: #0c5460;
    }

    .status-delivered {
      background-color: #d4edda;
      color: #155724;
    }

    .status-cancelled {
      background-color: #f8d7da;
      color: #721c24;
    }

    .section {
      padding: 20px 0;
    }

    .hidden {
      display: none !important;
    }

    .modal-content {
      border-radius: 12px;
      border: none;
    }

    .modal-header {
      background-color: var(--primary);
      color: white;
      border-radius: 12px 12px 0 0;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background-color: #ff9da3;
      border-color: #ff9da3;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(255, 176, 181, 0.25);
    }

    .feedback-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .nav-link.active {
      background-color: var(--primary) !important;
      color: white !important;
      border-radius: 20px;
    }

    @media (max-width: 768px) {
      .category-tab {
        padding: 8px 15px;
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <!-- Toasts -->
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Buyer Site -->
  <div id="buyerSite">
    <!-- Nav -->
    <nav class="navbar navbar-expand-lg navbar-light shadow-sm" style="background: #FFD3D6;">
      <div class="container">
        <a class="navbar-brand" href="#">
          <i class="fas fa-shopping-cart me-2"></i>Aiaxcart Premium Shop
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-section="home">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="admin.html" target="_blank">Admin</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="rules">Rules</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-section="feedback">Feedback</a>
            </li>
          </ul>
          <div class="d-flex align-items-center">
            <div id="userAuth">
              <button class="btn btn-outline-primary me-2" id="loginBtn">Login</button>
              <button class="btn btn-primary" id="signupBtn">Sign Up</button>
            </div>
            <div id="userProfile" class="hidden">
              <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                  <i class="fas fa-user me-1"></i> <span id="userName">User</span>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#" data-section="profile">My Account</a></li>
                  <li><a class="dropdown-item" href="#" data-section="orders">My Orders</a></li>
                  <li><a class="dropdown-item" href="#" data-section="report">Report Issue</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#" id="logoutBtn">Logout</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
      <!-- HOME -->
      <div id="homeSection" class="section">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Premium Accounts</h2>
          <div class="d-flex overflow-auto pb-2">
            <div class="category-tab active" data-category="all">All</div>
            <div class="category-tab" data-category="entertainment">Entertainment</div>
            <div class="category-tab" data-category="streaming">Streaming</div>
            <div class="category-tab" data-category="educational">Educational</div>
            <div class="category-tab" data-category="editing">Editing</div>
            <div class="category-tab" data-category="ai">AI</div>
          </div>
        </div>

        <div id="productsContainer" class="row">
          <!-- product cards -->
        </div>
      </div>

      <!-- RULES -->
      <div id="rulesSection" class="section hidden">
        <h2 class="mb-4">Shop Rules</h2>
        <div id="rulesContainer"></div>
      </div>

      <!-- FEEDBACK -->
      <div id="feedbackSection" class="section hidden">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Customer Feedback</h2>
          <button class="btn btn-primary" id="addFeedbackBtn" type="button">
            <i class="fas fa-plus me-1"></i> Add Feedback
          </button>
        </div>

        <div class="row">
          <div class="col-md-8">
            <div id="feedbackList"></div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Submit Feedback</h5>
                <form id="feedbackForm">
                  <div class="mb-3">
                    <label class="form-label" for="feedbackName">Your Name</label>
                    <input type="text" id="feedbackName" class="form-control" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="feedbackText">Your Feedback</label>
                    <textarea id="feedbackText" class="form-control" rows="4" required></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="feedbackImage">Image (Optional)</label>
                    <input type="file" id="feedbackImage" class="form-control" accept="image/*">
                  </div>
                  <button class="btn btn-primary w-100" type="submit">Submit Feedback</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PROFILE + ORDERS -->
      <div id="profileSection" class="section hidden">
        <h2 class="mb-4">My Account</h2>
        <div class="row">
          <div class="col-md-4">
            <div class="card">
              <div class="card-body text-center">
                <div class="buyer-profile-img" id="profileAvatar">JD</div>
                <h4 id="profileName">John Doe</h4>
                <p class="text-muted" id="profileEmail">john@example.com</p>
                <button class="btn btn-outline-primary btn-sm" type="button">Edit Profile</button>
              </div>
            </div>
          </div>
          <div class="col-md-8">
            <ul class="nav nav-tabs" id="profileTabs">
              <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#pendingOrders">Pending</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#confirmedOrders">Confirmed</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#deliveredAccounts">Delivered</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#orderHistory">History</a>
              </li>
            </ul>

            <div class="tab-content mt-3">
              <div class="tab-pane fade show active" id="pendingOrders">
                <div id="pendingOrdersList"></div>
              </div>
              <div class="tab-pane fade" id="confirmedOrders">
                <div id="confirmedOrdersList"></div>
              </div>
              <div class="tab-pane fade" id="deliveredAccounts">
                <div id="deliveredAccountsList"></div>
              </div>
              <div class="tab-pane fade" id="orderHistory">
                <div id="orderHistoryList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- REPORT ISSUE -->
      <div id="reportSection" class="section hidden">
        <h2 class="mb-4">Report an Issue</h2>
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-body">
                <form id="reportForm">
                  <div class="mb-3">
                    <label class="form-label" for="reportOrderId">Order ID</label>
                    <input type="text" id="reportOrderId" class="form-control" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="reportProduct">Product Name</label>
                    <input type="text" id="reportProduct" class="form-control" placeholder="Optional">
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="reportIssue">Issue Description</label>
                    <textarea id="reportIssue" class="form-control" rows="4" required></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="reportScreenshot">Screenshot (Optional)</label>
                    <input type="file" id="reportScreenshot" class="form-control" accept="image/*">
                  </div>
                  <button class="btn btn-primary" type="submit">Submit Report</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div> <!-- /container -->
  </div> <!-- /buyerSite -->

  <!-- PRODUCT MODAL -->
  <div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productModalTitle">Product Details</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="product-img mb-3">
                <span id="productModalIcon">ðŸ“º</span>
              </div>
              <h4 id="productModalName">Product Name</h4>
              <p class="text-muted" id="productModalDescription"></p>
              <div class="mb-3">
                <label class="form-label">Available Stock</label>
                <div class="fw-bold" id="availableStock">0</div>
              </div>
            </div>
            <div class="col-md-6">
              <form id="buyNowForm">
                <div class="mb-3">
                  <label class="form-label" for="accountType">Account Type</label>
                  <select id="accountType" class="form-select" required>
                    <option value="">Select account type</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label" for="duration">Duration</label>
                  <select id="duration" class="form-select" required>
                    <option value="">Select duration</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Price</label>
                  <div class="fw-bold fs-4 text-primary" id="productPrice">â‚±0.00</div>
                </div>
                <div class="mb-3 hidden" id="inviteEmailField">
                  <label class="form-label" for="gmail">Gmail Address</label>
                  <input type="email" id="gmail" class="form-control" placeholder="Enter valid Gmail address">
                </div>
                <button class="btn btn-primary w-100" id="checkoutBtn" type="submit">
                  Buy Now
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div class="modal fade" id="checkoutModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Checkout</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="checkoutForm">
            <div class="mb-3">
              <label class="form-label" for="paymentMethod">Payment Method</label>
              <select id="paymentMethod" class="form-select" required>
                <option value="">Select payment method</option>
                <option value="gcash">GCash - 09625544105 (SMM)</option>
                <option value="maya">Maya - 09298943629 (AF)</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label" for="referenceNumber">Reference Number</label>
              <input type="text" id="referenceNumber" class="form-control" placeholder="Enter reference number">
            </div>
            <div class="mb-3">
              <label class="form-label" for="proofImage">Proof of Payment (Screenshot)</label>
              <input type="file" id="proofImage" class="form-control" accept="image/*">
            </div>
            <div class="alert alert-info">
              <small>After submitting, your order will be processed and you'll receive a confirmation.</small>
            </div>
            <button class="btn btn-primary w-100" type="submit">Submit Order</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Login</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label" for="loginEmail">Email</label>
              <input type="email" id="loginEmail" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="loginPassword">Password</label>
              <input type="password" id="loginPassword" class="form-control" required>
            </div>
            <button class="btn btn-primary w-100" type="submit">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- SIGNUP MODAL -->
  <div class="modal fade" id="signupModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Sign Up</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="signupForm">
            <div class="mb-3">
              <label class="form-label" for="signupName">Full Name</label>
              <input type="text" id="signupName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="signupEmail">Email</label>
              <input type="email" id="signupEmail" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="signupPassword">Password</label>
              <input type="password" id="signupPassword" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="confirmPassword">Confirm Password</label>
              <input type="password" id="confirmPassword" class="form-control" required>
            </div>
            <button class="btn btn-primary w-100" type="submit">Create Account</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ======================
    // SUPABASE CONFIG
    // ======================
    const SUPABASE_URL = 'https://hnymqvkfmythdxtjqeam.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhueW1xdmtmbXl0aGR4dGpxZWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjE3NTUsImV4cCI6MjA3ODY5Nzc1NX0.4ww5fKNnbhNzNrkJZLa466b6BsKE_yYMO2YH6-auFlI';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let currentProduct = null;
    let currentOrderDetails = null;

    // ======================
    // DURATION MAP
    // ======================
    const durationMap = {
      '7d': '7 Days',
      '14d': '14 Days',
      '1m': '1 Month',
      '2m': '2 Months',
      '3m': '3 Months',
      '4m': '4 Months',
      '5m': '5 Months',
      '6m': '6 Months',
      '8m': '8 Months',
      '10m': '10 Months',
      '12m': '12 Months',
      '24m': '24 Months',
      'nw': 'No Warranty',
      '3m w': '3 Months Warranty',
      '6m w': '6 Months Warranty',
      '12m w': '12 Months Warranty'
    };

    // ======================
    // STATIC PRODUCT LIST
    // ======================
    const PRODUCTS_DATA = [/* â€” SAME PRODUCTS_DATA AS SA LATEST CODE MO â€” */];

    // (Para di humaba sobra dito sa chat, gamitin mo yung exact PRODUCTS_DATA
    // na nasa last message mo â€” pwede mo lang ipaste sa lugar na ito.)

    // ======================
    // UTILITIES
    // ======================
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const bsType = type === 'error' ? 'danger' : type;
      toast.className = `toast align-items-center text-bg-${bsType} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      document.getElementById('toastContainer').appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    function getInitials(name) {
      return name
        .split(' ')
        .filter(Boolean)
        .map(part => part[0])
        .join('')
        .toUpperCase();
    }

    function formatDate(dateString) {
      const d = new Date(dateString);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function isValidGmail(email) {
      return /^[a-zA-Z0-9.]+@gmail\.com$/.test(email);
    }

    function generateOrderId() {
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      const rand = Math.floor(1000 + Math.random() * 9000);
      return `AXP-${y}${m}${d}-${rand}`;
    }

    // ======================
    // SUPABASE HELPERS
    // ======================
    async function saveBuyerToSupabase(buyer) {
      try {
        const { data, error } = await supabase
          .from('buyers')
          .insert({
            name: buyer.name,
            email: buyer.email.toLowerCase()
          });

        if (error) {
          console.error('Error saving buyer:', error.message, error.details, error.hint);
          showToast('Error saving buyer to database', 'error');
          return null;
        }
        return data;
      } catch (err) {
        console.error('saveBuyerToSupabase error:', err);
        showToast('Error saving buyer to database', 'error');
        return null;
      }
    }

    async function saveOrderToSupabase(order) {
      const { data, error } = await supabase
        .from('orders')
        .insert(order)
        .select();

      if (error) {
        console.error('Error saving order:', error.message, error.details, error.hint);
        showToast('Error saving order to database', 'error');
        return null;
      }
      return data;
    }

    async function sendTelegramNotification(order) {
      const message = `
ðŸ›’ NEW ORDER RECEIVED!
Order ID: ${order.id || '(auto)'}
Buyer: ${order.buyer_email}
Product: ${order.product_name}
Account Type: ${order.account_type}
Duration: ${order.duration}
Price: â‚±${order.price}
Payment Method: ${order.payment_method}
      `;
      console.log('[Telegram mock]', message);
    }

    // ======================
    // SECTIONS / NAV
    // ======================
    function showSection(sectionKey) {
      const id = sectionKey.endsWith('Section') ? sectionKey : `${sectionKey}Section`;
      document.querySelectorAll('.section').forEach(sec => sec.classList.add('hidden'));
      const target = document.getElementById(id);
      if (target) target.classList.remove('hidden');

      document.querySelectorAll('.nav-link[data-section]').forEach(a => a.classList.remove('active'));
      const nav = document.querySelector(`.nav-link[data-section="${sectionKey.replace('Section', '')}"]`);
      if (nav) nav.classList.add('active');
    }

    function showUserAuth() {
      document.getElementById('userAuth').classList.remove('hidden');
      document.getElementById('userProfile').classList.add('hidden');
    }

    function showUserProfile() {
      document.getElementById('userAuth').classList.add('hidden');
      document.getElementById('userProfile').classList.remove('hidden');
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('profileName').textContent = currentUser.name;
      document.getElementById('profileEmail').textContent = currentUser.email;
      document.getElementById('profileAvatar').textContent = getInitials(currentUser.name);

      loadUserOrders();
      loadDeliveredAccounts();
    }

    // ======================
    // PRODUCTS DISPLAY
    // ======================
    function loadProducts() {
      displayProducts(PRODUCTS_DATA);
    }

    function displayProducts(products) {
      const container = document.getElementById('productsContainer');
      container.innerHTML = '';

      products.forEach(product => {
        let minPrice = Infinity;
        Object.values(product.pricing).forEach(tier => {
          Object.values(tier).forEach(price => {
            if (price < minPrice) minPrice = price;
          });
        });
        if (!Number.isFinite(minPrice)) minPrice = 0;

        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-3 mb-4';
        col.innerHTML = `
          <div class="card product-card" data-product-id="${product.id}" data-category="${product.category}">
            <div class="card-body text-center">
              <div class="product-img mb-3">
                <span style="font-size: 2.5rem;">${product.icon}</span>
              </div>
              <h6 class="card-title mb-1">${product.name}</h6>
              <p class="card-text text-muted small mb-2 text-capitalize">${product.category}</p>
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="badge bg-secondary text-capitalize">${product.category}</span>
                <span class="text-primary fw-bold small">From â‚±${minPrice}</span>
              </div>
              <small class="text-muted d-block mb-2">Stock: ${product.stock}</small>
              <button class="btn btn-primary btn-sm w-100 view-product-btn" ${product.stock === 0 ? 'disabled' : ''}>
                ${product.stock === 0 ? 'Out of Stock' : 'View Details'}
              </button>
            </div>
          </div>
        `;
        container.appendChild(col);
      });

      document.querySelectorAll('.view-product-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const card = btn.closest('.product-card');
          const id = card.getAttribute('data-product-id');
          openProductModal(id);
        });
      });
    }

    function filterProducts(category) {
      const cards = document.querySelectorAll('.product-card');
      cards.forEach(card => {
        const c = card.getAttribute('data-category');
        if (category === 'all' || !category) {
          card.style.display = '';
        } else {
          card.style.display = c === category ? '' : 'none';
        }
      });
    }

    function openProductModal(productId) {
      const product = PRODUCTS_DATA.find(p => p.id === productId);
      if (!product) {
        showToast('Product not found', 'error');
        return;
      }

      currentProduct = product;

      document.getElementById('productModalTitle').textContent = product.name;
      document.getElementById('productModalIcon').textContent = product.icon;
      document.getElementById('productModalName').textContent = product.name;
      document.getElementById('productModalDescription').textContent =
        `${product.category} â€¢ ${product.stock} in stock`;
      document.getElementById('availableStock').textContent = product.stock;
      document.getElementById('productPrice').textContent = 'â‚±0.00';
      document.getElementById('buyNowForm').reset();

      const inviteField = document.getElementById('inviteEmailField');
      inviteField.classList.add('hidden');

      const accountTypeSelect = document.getElementById('accountType');
      const durationSelect = document.getElementById('duration');
      accountTypeSelect.innerHTML = '<option value="">Select account type</option>';
      durationSelect.innerHTML = '<option value="">Select duration</option>';

      Object.keys(product.pricing).forEach(typeKey => {
        const opt = document.createElement('option');
        opt.value = typeKey;
        opt.textContent = typeKey;
        accountTypeSelect.appendChild(opt);
      });

      accountTypeSelect.onchange = () => {
        const type = accountTypeSelect.value;
        durationSelect.innerHTML = '<option value="">Select duration</option>';
        if (type && product.pricing[type]) {
          Object.keys(product.pricing[type]).forEach(dKey => {
            const opt = document.createElement('option');
            opt.value = dKey;
            opt.textContent = durationMap[dKey] || dKey;
            durationSelect.appendChild(opt);
          });
        }
        updateInviteField();
        updatePrice();
      };

      durationSelect.onchange = () => {
        updatePrice();
      };

      document.getElementById('buyNowForm').onsubmit = (e) => {
        e.preventDefault();
        handleBuyNow();
      };

      const productModal = new bootstrap.Modal(document.getElementById('productModal'));
      productModal.show();
    }

    function updateInviteField() {
      const type = (document.getElementById('accountType').value || '').toLowerCase();
      const inviteField = document.getElementById('inviteEmailField');
      if (type.includes('invite')) {
        inviteField.classList.remove('hidden');
      } else {
        inviteField.classList.add('hidden');
      }
    }

    function updatePrice() {
      const type = document.getElementById('accountType').value;
      const duration = document.getElementById('duration').value;
      if (currentProduct && type && duration && currentProduct.pricing[type]) {
        const price = currentProduct.pricing[type][duration];
        if (price != null) {
          document.getElementById('productPrice').textContent = `â‚±${price}`;
          return;
        }
      }
      document.getElementById('productPrice').textContent = 'â‚±0.00';
    }

    function handleBuyNow() {
      if (!currentUser) {
        showToast('Please login to continue', 'warning');
        const modal = new bootstrap.Modal(document.getElementById('loginModal'));
        modal.show();
        return;
      }

      const type = document.getElementById('accountType').value;
      const duration = document.getElementById('duration').value;
      if (!type || !duration) {
        showToast('Please select account type and duration', 'warning');
        return;
      }

      let inviteEmail = null;
      if (type.toLowerCase().includes('invite')) {
        inviteEmail = document.getElementById('gmail').value.trim();
        if (!inviteEmail || !isValidGmail(inviteEmail)) {
          showToast('Please enter a valid Gmail address', 'warning');
          return;
        }
      }

      const priceText = document.getElementById('productPrice').textContent;
      const price = Number(priceText.replace('â‚±', '')) || 0;

      currentOrderDetails = {
        productId: currentProduct.id,
        productName: currentProduct.name,
        accountType: type,
        duration,
        price,
        inviteEmail
      };

      bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
      const checkoutModal = new bootstrap.Modal(document.getElementById('checkoutModal'));
      checkoutModal.show();
    }

    // ======================
    // RULES & FEEDBACK (STATIC)
    // ======================
    function loadRules() {
      const container = document.getElementById('rulesContainer');
      container.innerHTML = `
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0">General Rules</h5>
          </div>
          <div class="card-body">
            <ul class="list-group list-group-flush">
              <li class="list-group-item">All accounts are guaranteed for the duration purchased.</li>
              <li class="list-group-item">Refunds only if the account does not work within 24 hours.</li>
              <li class="list-group-item">Sharing account details with others may result in suspension.</li>
            </ul>
          </div>
        </div>
      `;
    }

    function loadFeedback() {
      const feedback = [
        { id: 1, buyer_name: 'John D.', feedback_text: 'Great service! My account works perfectly.', photo_url: null, created_at: '2023-05-15T10:30:00Z' },
        { id: 2, buyer_name: 'Sarah M.', feedback_text: 'Fast delivery and good support.', photo_url: null, created_at: '2023-05-10T14:22:00Z' },
        { id: 3, buyer_name: 'Mike T.', feedback_text: 'Had an issue but support fixed it quickly.', photo_url: null, created_at: '2023-05-05T09:15:00Z' }
      ];
      const container = document.getElementById('feedbackList');
      container.innerHTML = '';
      feedback.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
          <div class="card-body">
            <div class="d-flex">
              <div class="feedback-avatar me-3">${getInitials(item.buyer_name)}</div>
              <div class="flex-grow-1">
                <h6 class="mb-1">${item.buyer_name}</h6>
                <p class="mb-2">${item.feedback_text}</p>
                ${item.photo_url ? `<img src="${item.photo_url}" class="img-fluid rounded mb-2" style="max-height:200px;">` : ''}
                <small class="text-muted">${formatDate(item.created_at)}</small>
              </div>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function submitFeedback(e) {
      e.preventDefault();
      const name = document.getElementById('feedbackName').value.trim();
      const text = document.getElementById('feedbackText').value.trim();
      if (!name || !text) {
        showToast('Please fill in all required fields', 'warning');
        return;
      }
      showToast('Feedback submitted! (mock only)', 'success');
      document.getElementById('feedbackForm').reset();
      loadFeedback();
    }

    // ======================
    // LOAD USER ORDERS (REAL)
    // ======================
    async function loadUserOrders() {
      if (!currentUser) return;

      try {
        const { data: orderRows, error } = await supabase
          .from('orders')
          .select('id, product_id, product_name, account_type, duration, price, status, created_at, buyer_email')
          .eq('buyer_email', currentUser.email.toLowerCase())
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error loading user orders:', error);
          showToast('Error loading your orders', 'error');
          return;
        }

        if (!orderRows || !orderRows.length) {
          displayUserOrders([]);
          return;
        }

        const orders = orderRows.map(o => ({
          id: o.id,
          product_name: o.product_name || o.product_id,
          account_type: o.account_type,
          duration: o.duration,
          price: o.price,
          status: (o.status || 'pending').toLowerCase(),
          created_at: o.created_at
        }));

        displayUserOrders(orders);
      } catch (err) {
        console.error('loadUserOrders error:', err);
        showToast('Error loading your orders', 'error');
      }
    }

    function displayUserOrders(orders) {
      const pending = document.getElementById('pendingOrdersList');
      const confirmed = document.getElementById('confirmedOrdersList');
      const history = document.getElementById('orderHistoryList');

      pending.innerHTML = '';
      confirmed.innerHTML = '';
      history.innerHTML = '';

      orders.forEach(order => {
        const card = document.createElement('div');
        card.className = 'card mb-3';
        card.innerHTML = `
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h6 class="mb-1">${order.product_name}</h6>
                <p class="mb-1 small">Order ID: ${order.id}</p>
                <p class="mb-1 small">Account Type: ${order.account_type} â€¢ Duration: ${order.duration}</p>
                <p class="mb-0 fw-bold">â‚±${order.price}</p>
              </div>
              <div class="text-end">
                <span class="order-status status-${order.status} text-capitalize">${order.status}</span>
                <div class="mt-2">
                  <small class="text-muted">${formatDate(order.created_at)}</small>
                </div>
              </div>
            </div>
          </div>
        `;

        if (order.status === 'pending') pending.appendChild(card.cloneNode(true));
        if (order.status === 'confirmed') confirmed.appendChild(card.cloneNode(true));
        history.appendChild(card);
      });

      if (!orders.length) {
        pending.innerHTML = '<p class="text-muted">No pending orders.</p>';
        confirmed.innerHTML = '<p class="text-muted">No confirmed orders.</p>';
        history.innerHTML = '<p class="text-muted">No order history yet.</p>';
      }
    }

    // ======================
    // LOAD DELIVERED ACCOUNTS (records)
    // ======================
    async function loadDeliveredAccounts() {
      if (!currentUser) return;

      const container = document.getElementById('deliveredAccountsList');
      if (!container) return;

      container.innerHTML = '<p class="text-muted">Loading delivered accounts...</p>';

      try {
        const { data, error } = await supabase
          .from('records')
          .select('id, order_id, product_name, account_type, duration, price, purchase_date, email, password, profile, pin, buyer_email')
          .eq('buyer_email', currentUser.email.toLowerCase())
          .order('purchase_date', { ascending: false });

        if (error) {
          console.error('Error loading delivered accounts:', error);
          showToast('Error loading delivered accounts', 'error');
          container.innerHTML = '<p class="text-muted">Failed to load delivered accounts.</p>';
          return;
        }

        if (!data || !data.length) {
          container.innerHTML = '<p class="text-muted">No delivered accounts yet.</p>';
          return;
        }

        container.innerHTML = '';
        data.forEach(rec => {
          const card = document.createElement('div');
          card.className = 'card mb-3';
          card.innerHTML = `
            <div class="card-body">
              <h6 class="mb-1">${rec.product_name || 'Delivered Account'}</h6>
              <p class="mb-1 small">Order ID: ${rec.order_id || rec.id}</p>
              <p class="mb-1 small">Account Type: ${rec.account_type || '-'} â€¢ Duration: ${rec.duration || '-'}</p>
              <p class="mb-1 small">Account Email: <strong>${rec.email || '-'}</strong></p>
              <p class="mb-1 small">Password: <strong>${rec.password || '-'}</strong></p>
              ${rec.profile ? `<p class="mb-1 small">Profile: <strong>${rec.profile}</strong></p>` : ''}
              ${rec.pin ? `<p class="mb-1 small">PIN: <strong>${rec.pin}</strong></p>` : ''}
              <p class="mb-1 small">Purchase Date: ${rec.purchase_date ? formatDate(rec.purchase_date) : '-'}</p>
              <p class="mb-0 fw-bold">â‚±${rec.price ?? 0}</p>
            </div>
          `;
          container.appendChild(card);
        });
      } catch (err) {
        console.error('loadDeliveredAccounts error:', err);
        showToast('Error loading delivered accounts', 'error');
      }
    }

    // ======================
    // REPORT
    // ======================
    function submitReport(e) {
      e.preventDefault();
      const orderId = document.getElementById('reportOrderId').value.trim();
      const issue = document.getElementById('reportIssue').value.trim();
      if (!orderId || !issue) {
        showToast('Please fill in all required fields', 'warning');
        return;
      }
      showToast('Report submitted! (mock only)', 'success');
      document.getElementById('reportForm').reset();
      showSection('profile');
    }

    // ======================
    // AUTH
    // ======================
    async function handleSignup(e) {
      e.preventDefault();

      const name = document.getElementById('signupName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      if (!name || !email) {
        showToast('Please fill in name and email', 'warning');
        return;
      }
      if (password !== confirmPassword) {
        showToast('Passwords do not match', 'error');
        return;
      }

      const normalizedEmail = email.toLowerCase();

      const user = {
        name: name,
        email: normalizedEmail
      };

      await saveBuyerToSupabase(user);

      currentUser = user;
      localStorage.setItem('aiaxcart_user', JSON.stringify(user));

      showUserProfile();
      await loadUserOrders();
      await loadDeliveredAccounts();

      bootstrap.Modal.getInstance(document.getElementById('signupModal')).hide();
      showToast('Account created successfully!', 'success');
    }

    async function handleLogin(e) {
      e.preventDefault();

      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!email) {
        showToast('Please enter your email', 'warning');
        return;
      }

      const normalizedEmail = email.toLowerCase();
      const name = normalizedEmail.split('@')[0];

      const user = {
        name: name,
        email: normalizedEmail
      };

      currentUser = user;
      localStorage.setItem('aiaxcart_user', JSON.stringify(user));

      showUserProfile();
      await loadUserOrders();
      await loadDeliveredAccounts();

      bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
      showToast('Login successful!', 'success');
    }

    function handleLogout(e) {
      e.preventDefault();
      currentUser = null;
      localStorage.removeItem('aiaxcart_user');
      showUserAuth();
      showSection('home');
      showToast('Logged out.', 'success');
    }

    // ======================
    // CHECKOUT (REAL ORDER)
    // ======================
    async function handleCheckout(e) {
      e.preventDefault();

      if (!currentUser) {
        showToast('Please login first', 'warning');
        return;
      }

      const paymentMethod = document.getElementById('paymentMethod').value;
      const referenceNumber = document.getElementById('referenceNumber').value;

      if (!paymentMethod) {
        showToast('Please select a payment method', 'warning');
        return;
      }

      if (!currentOrderDetails) {
        showToast('No product selected', 'error');
        return;
      }

      try {
        const order = {
          buyer_email: currentUser.email.toLowerCase(),
          product_id: currentOrderDetails.productId,
          product_name: currentOrderDetails.productName,
          account_type: currentOrderDetails.accountType,
          duration: currentOrderDetails.duration,
          price: currentOrderDetails.price,
          payment_method: paymentMethod,
          reference_number: referenceNumber || null,
          invite_email: currentOrderDetails.inviteEmail,
          status: 'pending',
          created_at: new Date().toISOString()
        };

        const saved = await saveOrderToSupabase(order);
        if (!saved || !saved.length) return;

        const newOrder = saved[0];

        await sendTelegramNotification({
          ...order,
          id: newOrder.id
        });

        bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
        showToast(`Order submitted successfully! Your order ID is ${newOrder.id}`, 'success');

        document.getElementById('checkoutForm').reset();
        await loadUserOrders();
      } catch (err) {
        console.error('Checkout error:', err);
        showToast('Error submitting order', 'error');
      }
    }

    // ======================
    // INIT & EVENTS
    // ======================
    function setupEventListeners() {
      document.querySelectorAll('[data-section]').forEach(link => {
        link.addEventListener('click', e => {
          const section = link.getAttribute('data-section');
          if (!section) return;
          e.preventDefault();
          if (section === 'profile') showSection('profile');
          else if (section === 'rules') showSection('rules');
          else if (section === 'feedback') showSection('feedback');
          else if (section === 'report') showSection('report');
          else if (section === 'home') showSection('home');
        });
      });

      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          const cat = tab.getAttribute('data-category');
          filterProducts(cat);
        });
      });

      document.getElementById('loginBtn').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('loginModal'));
        modal.show();
      });
      document.getElementById('signupBtn').addEventListener('click', () => {
        const modal = new bootstrap.Modal(document.getElementById('signupModal'));
        modal.show();
      });
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);

      document.getElementById('loginForm').addEventListener('submit', handleLogin);
      document.getElementById('signupForm').addEventListener('submit', handleSignup);
      document.getElementById('checkoutForm').addEventListener('submit', handleCheckout);
      document.getElementById('feedbackForm').addEventListener('submit', submitFeedback);
      document.getElementById('reportForm').addEventListener('submit', submitReport);
    }

    function initializeApp() {
      const stored = localStorage.getItem('aiaxcart_user');
      if (stored) {
        try {
          currentUser = JSON.parse(stored);
          showUserProfile();
        } catch {
          showUserAuth();
        }
      } else {
        showUserAuth();
      }

      showSection('home');
      loadProducts();
      loadRules();
      loadFeedback();
    }

    document.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      setupEventListeners();
    });
  </script>
</body>
</html>
