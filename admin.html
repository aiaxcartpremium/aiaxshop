// ===== SUPABASE DATABASE FUNCTIONS =====
// Add this after your existing JavaScript code, before the closing </script> tag

// Database Functions
async function saveProductToSupabase(product) {
    const { data, error } = await supabase
        .from('products')
        .insert([product]);
    
    if (error) {
        console.error('Error saving product:', error);
        showToast('Error saving product', 'error');
        return null;
    } else {
        showToast('Product saved to database!', 'success');
        return data;
    }
}

async function loadProductsFromSupabase() {
    const { data, error } = await supabase
        .from('products')
        .select('*');
    
    if (error) {
        console.error('Error loading products:', error);
        showToast('Error loading products from database', 'error');
        return products; // Fallback to local data
    } else {
        showToast('Products loaded from database!', 'success');
        return data;
    }
}

async function saveStockToSupabase(stock) {
    const { data, error } = await supabase
        .from('stocks')
        .insert([stock]);
    
    if (error) {
        console.error('Error saving stock:', error);
        showToast('Error saving stock', 'error');
        return null;
    } else {
        showToast('Stock saved to database!', 'success');
        return data;
    }
}

async function loadStocksFromSupabase() {
    const { data, error } = await supabase
        .from('stocks')
        .select('*');
    
    if (error) {
        console.error('Error loading stocks:', error);
        showToast('Error loading stocks from database', 'error');
        return stocks; // Fallback to local data
    } else {
        return data;
    }
}

async function saveOrderToSupabase(order) {
    const { data, error } = await supabase
        .from('orders')
        .insert([order]);
    
    if (error) {
        console.error('Error saving order:', error);
        showToast('Error saving order', 'error');
        return null;
    } else {
        showToast('Order saved to database!', 'success');
        return data;
    }
}

async function loadOrdersFromSupabase() {
    const { data, error } = await supabase
        .from('orders')
        .select('*');
    
    if (error) {
        console.error('Error loading orders:', error);
        showToast('Error loading orders from database', 'error');
        return orders; // Fallback to local data
    } else {
        return data;
    }
}

async function saveRecordToSupabase(record) {
    const { data, error } = await supabase
        .from('records')
        .insert([record]);
    
    if (error) {
        console.error('Error saving record:', error);
        showToast('Error saving record', 'error');
        return null;
    } else {
        showToast('Record saved to database!', 'success');
        return data;
    }
}

async function loadRecordsFromSupabase() {
    const { data, error } = await supabase
        .from('records')
        .select('*');
    
    if (error) {
        console.error('Error loading records:', error);
        showToast('Error loading records from database', 'error');
        return soldRecords; // Fallback to local data
    } else {
        return data;
    }
}

async function saveBuyerToSupabase(buyer) {
    const { data, error } = await supabase
        .from('buyers')
        .insert([buyer]);
    
    if (error) {
        console.error('Error saving buyer:', error);
        return null;
    } else {
        return data;
    }
}

// ===== UPDATE EXISTING FUNCTIONS TO USE SUPABASE =====

// Update addProduct function to save to Supabase
async function addProduct() {
    const name = document.getElementById('product-name').value;
    const key = document.getElementById('product-key').value;
    const category = document.getElementById('product-category').value;
    const icon = document.getElementById('product-icon').value;
    const stock = parseInt(document.getElementById('product-stock').value) || 0;

    // Collect pricing data
    const pricing = {};
    document.querySelectorAll('.pricing-tier').forEach(tier => {
        const accountType = tier.querySelector('.account-type').value.toLowerCase();
        const durations = {};
        
        tier.querySelectorAll('.duration-price').forEach(durationPrice => {
            const duration = durationPrice.querySelector('.duration-select').value;
            const price = parseFloat(durationPrice.querySelector('.price-input').value);
            if (duration && !isNaN(price)) {
                durations[duration] = price;
            }
        });
        
        if (accountType && Object.keys(durations).length > 0) {
            pricing[accountType] = durations;
        }
    });

    // Create new product
    const newProduct = {
        id: key,
        name: name,
        category: category,
        icon: icon,
        stock: stock,
        pricing: pricing
    };

    // Save to Supabase
    const result = await saveProductToSupabase(newProduct);
    
    if (result) {
        // Add to local products array only if Supabase save was successful
        products.push(newProduct);

        // Reset form
        document.getElementById('addProductForm').reset();
        document.getElementById('pricing-container').innerHTML = '';
        addPricingTier(); // Add one empty tier

        // Update displays
        updateStats();
        loadProductsForAdmin();
    }
}

// Update addStock function to save to Supabase
async function addStock() {
    const productId = document.getElementById('stock-product').value;
    const accountType = document.getElementById('stock-type').value;
    const duration = document.getElementById('stock-duration').value;
    const quantity = parseInt(document.getElementById('stock-qty').value) || 1;
    const email = document.getElementById('stock-email').value;
    const password = document.getElementById('stock-password').value;
    const profile = document.getElementById('stock-profile').value;
    const pin = document.getElementById('stock-pin').value;
    const archiveDays = parseInt(document.getElementById('stock-arch').value) || 30;
    const premiumUntil = document.getElementById('stock-premdate').value;

    let successCount = 0;

    // Add stock items to Supabase
    for (let i = 0; i < quantity; i++) {
        const stockItem = {
            id: Date.now() + '-' + i,
            productId: productId,
            accountType: accountType,
            duration: duration,
            email: email,
            password: password,
            profile: profile,
            pin: pin,
            archiveAfter: archiveDays,
            premiumUntil: premiumUntil,
            status: 'available',
            createdAt: new Date().toISOString()
        };

        const result = await saveStockToSupabase(stockItem);
        if (result) {
            stocks.push(stockItem);
            successCount++;
        }
    }

    // Reset form
    document.getElementById('addStockForm').reset();

    // Show success message
    if (successCount > 0) {
        document.getElementById('add-stock-msg').innerHTML = 
            `<div class="alert alert-success">Added ${successCount} stock item(s) successfully to database!</div>`;
        
        // Update displays
        updateStats();
        showStocks();
    }

    setTimeout(() => {
        document.getElementById('add-stock-msg').innerHTML = '';
    }, 3000);
}

// Update addRecord function to save to Supabase
async function addRecord() {
    const orderId = document.getElementById("record-orderid").value || generateOrderId();
    const buyer = document.getElementById("record-buyer").value;
    const source = document.getElementById("record-source").value;
    const productId = document.getElementById("record-product").value;
    const accountType = document.getElementById("record-type").value;
    const duration = document.getElementById("record-duration").value;
    const purchaseDate = document.getElementById("record-purchasedate").value;
    const additionalDays = Number(document.getElementById("record-adddays").value) || 0;
    const email = document.getElementById("record-email").value;
    const password = document.getElementById("record-password").value;
    const profile = document.getElementById("record-profile").value;
    const pin = document.getElementById("record-pin").value;
    const price = Number(document.getElementById("record-price").value) || 0;

    // Create record
    const record = {
        id: generateOrderId(),
        orderId: orderId,
        buyer: buyer,
        source: source,
        productId: productId,
        accountType: accountType,
        duration: duration,
        purchaseDate: purchaseDate,
        additionalDays: additionalDays,
        email: email,
        password: password,
        profile: profile,
        pin: pin,
        price: price,
        status: 'sold',
        createdAt: new Date().toISOString()
    };

    // Save to Supabase
    const result = await saveRecordToSupabase(record);
    
    if (result) {
        soldRecords.push(record);

        // Reset form
        document.getElementById("addRecordForm").reset();
        document.getElementById("record-purchasedate").value = new Date().toISOString().split('T')[0];
        
        // Show success message
        document.getElementById("add-record-msg").innerHTML = 
            '<div class="alert alert-success">Record added to database successfully!</div>';
        
        // Update displays
        showRecords();
        updateStats();
    }

    setTimeout(() => {
        document.getElementById("add-record-msg").innerHTML = '';
    }, 3000);
}

// Update showAdminPanel to load data from Supabase
async function showAdminPanel() {
    document.getElementById('admin-dashboard').style.display = 'block';
    await updateStats();
    await loadProductsForAdmin();
    showStocks();
    showPending();
    showSold();
    showRules();
    showRecords();
    showReports();
}

// Update loadProductsForAdmin to load from Supabase
async function loadProductsForAdmin() {
    // Try to load from Supabase first
    const supabaseProducts = await loadProductsFromSupabase();
    if (supabaseProducts && supabaseProducts.length > 0) {
        products = supabaseProducts;
    }
    
    // Rest of your existing loadProductsForAdmin code...
    // [Keep all the existing code for populating dropdowns, etc.]
}
