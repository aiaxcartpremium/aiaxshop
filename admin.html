<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aiaxcart Premium | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap / Icons / Supabase -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #FFB0B5;
      --secondary: #FFD3D6;
      --dark: #382f2c;
      --light: #fefaf7;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--dark);
    }

    header {
      background: var(--secondary);
      box-shadow: 0 4px 18px rgba(0,0,0,0.06);
    }

    .logo {
      font-weight: 700;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      gap: .5rem;
      color: var(--dark);
    }

    .logo span {
      color: var(--primary);
    }

    .stat-card {
      border-radius: 16px;
      padding: 1rem 1.2rem;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .stat-label {
      font-size: .85rem;
      color: #7c6a63;
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: .2rem;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .badge-status {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: .75rem;
      font-weight: 600;
    }

    .badge-pending { background:#fff3cd; color:#856404; }
    .badge-confirmed { background:#d1ecf1; color:#0c5460; }
    .badge-delivered { background:#d4edda; color:#155724; }
    .badge-cancelled { background:#f8d7da; color:#721c24; }

    .nav-pills .nav-link {
      border-radius: 999px;
    }

    .nav-pills .nav-link.active {
      background-color: var(--primary);
    }

    .table thead th {
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #7c6a63;
    }

    .table tbody td {
      vertical-align: middle;
      font-size: .9rem;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 260px;
    }

    @media (max-width: 768px) {
      .stat-card {
        margin-bottom: .75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Toast container -->
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- HEADER -->
  <header class="py-3 mb-4">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="logo">
        <i class="fas fa-crown"></i>
        <span>Aiaxcart</span> Premium Admin
      </div>
      <a href="index.html" class="btn btn-outline-dark btn-sm">
        <i class="fas fa-store me-1"></i>Buyer Site
      </a>
    </div>
  </header>

  <main class="container mb-5">
    <!-- ANALYTICS -->
    <section class="mb-4">
      <div class="row g-3" id="analyticsRow">
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-label">Total Orders</div>
            <div class="stat-value" id="totalOrders">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-label">Pending</div>
            <div class="stat-value text-warning" id="pendingOrders">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-label">Confirmed</div>
            <div class="stat-value text-info" id="confirmedOrders">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-label">Delivered</div>
            <div class="stat-value text-success" id="deliveredOrders">0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ORDERS TABS -->
    <section>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Orders</h4>
      </div>

      <ul class="nav nav-pills mb-3" id="ordersTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-pending" data-bs-toggle="pill"
                  data-bs-target="#pane-pending" type="button" role="tab">
            Pending
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-confirmed" data-bs-toggle="pill"
                  data-bs-target="#pane-confirmed" type="button" role="tab">
            Confirmed
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-delivered" data-bs-toggle="pill"
                  data-bs-target="#pane-delivered" type="button" role="tab">
            Delivered
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-cancelled" data-bs-toggle="pill"
                  data-bs-target="#pane-cancelled" type="button" role="tab">
            Cancelled
          </button>
        </li>
      </ul>

      <div class="tab-content" id="ordersTabContent">
        <!-- Pending -->
        <div class="tab-pane fade show active" id="pane-pending" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Order Code</th>
                  <th>Buyer</th>
                  <th>Product</th>
                  <th>Type / Duration</th>
                  <th>Price</th>
                  <th>Payment</th>
                  <th>Ref No.</th>
                  <th>Created</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="tblPending"></tbody>
            </table>
          </div>
        </div>

        <!-- Confirmed (read-only actions) -->
        <div class="tab-pane fade" id="pane-confirmed" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Order Code</th>
                  <th>Buyer</th>
                  <th>Product</th>
                  <th>Type / Duration</th>
                  <th>Price</th>
                  <th>Payment</th>
                  <th>Ref No.</th>
                  <th>Created</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="tblConfirmed"></tbody>
            </table>
          </div>
        </div>

        <!-- Delivered -->
        <div class="tab-pane fade" id="pane-delivered" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Order Code</th>
                  <th>Buyer</th>
                  <th>Product</th>
                  <th>Type / Duration</th>
                  <th>Price</th>
                  <th>Payment</th>
                  <th>Ref No.</th>
                  <th>Created</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tblDelivered"></tbody>
            </table>
          </div>
        </div>

        <!-- Cancelled -->
        <div class="tab-pane fade" id="pane-cancelled" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Order Code</th>
                  <th>Buyer</th>
                  <th>Product</th>
                  <th>Type / Duration</th>
                  <th>Price</th>
                  <th>Payment</th>
                  <th>Ref No.</th>
                  <th>Created</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tblCancelled"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==============================
    // SUPABASE CONFIG (same as index)
    // ==============================
    const SUPABASE_URL = 'https://hnymqvkfmythdxtjqeam.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhueW1xdmtmbXl0aGR4dGpxZWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjE3NTUsImV4cCI6MjA3ODY5Nzc1NX0.4ww5fKNnbhNzNrkJZLa466b6BsKE_yYMO2YH6-auFlI';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let ALL_ORDERS = [];

    // ==============================
    // UTILITIES
    // ==============================
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const bsType = type === 'error' ? 'danger' : type;
      toast.className = `toast align-items-center text-bg-${bsType} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      document.getElementById('toastContainer').appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const d = new Date(dateString);
      if (isNaN(d.getTime())) return dateString;
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function statusBadge(status) {
      const s = (status || '').toLowerCase();
      let cls = 'badge-status badge-secondary';
      if (s === 'pending') cls = 'badge-status badge-pending';
      else if (s === 'confirmed') cls = 'badge-status badge-confirmed';
      else if (s === 'delivered') cls = 'badge-status badge-delivered';
      else if (s === 'cancelled') cls = 'badge-status badge-cancelled';
      return `<span class="${cls} text-capitalize">${s || '-'}</span>`;
    }

    // ==============================
    // LOAD ORDERS
    // ==============================
    async function loadOrders() {
      try {
        const { data, error } = await supabase
          .from('orders')
          .select('id, order_code, buyer_email, product_id, product_name, account_type, duration, price, payment_method, reference_number, invite_email, status, created_at')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error loading orders:', error);
          showToast('Error loading orders from database', 'error');
          return;
        }

        ALL_ORDERS = data || [];
        updateAnalytics();
        renderAllOrderTables();
      } catch (err) {
        console.error('loadOrders error:', err);
        showToast('Unexpected error loading orders', 'error');
      }
    }

    function updateAnalytics() {
      const total = ALL_ORDERS.length;
      const pending = ALL_ORDERS.filter(o => (o.status || '').toLowerCase() === 'pending').length;
      const confirmed = ALL_ORDERS.filter(o => (o.status || '').toLowerCase() === 'confirmed').length;
      const delivered = ALL_ORDERS.filter(o => (o.status || '').toLowerCase() === 'delivered').length;

      document.getElementById('totalOrders').textContent = total;
      document.getElementById('pendingOrders').textContent = pending;
      document.getElementById('confirmedOrders').textContent = confirmed;
      document.getElementById('deliveredOrders').textContent = delivered;
    }

    function renderAllOrderTables() {
      renderOrdersByStatus('pending',   document.getElementById('tblPending'),   11, true);
      renderOrdersByStatus('confirmed', document.getElementById('tblConfirmed'), 11, false);
      renderOrdersByStatus('delivered', document.getElementById('tblDelivered'), 10, false);
      renderOrdersByStatus('cancelled', document.getElementById('tblCancelled'), 10, false);
    }

    function renderOrdersByStatus(statusKey, tbodyEl, colCount, withActions) {
      tbodyEl.innerHTML = '';

      const rows = ALL_ORDERS.filter(
        o => (o.status || '').toLowerCase() === statusKey.toLowerCase()
      );

      if (!rows.length) {
        tbodyEl.innerHTML = `
          <tr>
            <td colspan="${colCount}" class="text-center text-muted py-3">
              No ${statusKey} orders.
            </td>
          </tr>
        `;
        return;
      }

      rows.forEach(order => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order.id}</td>
          <td>${order.order_code || '-'}</td>
          <td>
            <div class="fw-semibold small">${order.buyer_email || '-'}</div>
            ${order.invite_email ? `<div class="small text-muted">Invite: ${order.invite_email}</div>` : ''}
          </td>
          <td>${order.product_name || '-'}</td>
          <td>
            <div class="small">${order.account_type || '-'}</div>
            <div class="small text-muted">${order.duration || '-'}</div>
          </td>
          <td>â‚±${order.price ?? 0}</td>
          <td class="small text-capitalize">${order.payment_method || '-'}</td>
          <td class="small">${order.reference_number || '-'}</td>
          <td class="small">${formatDate(order.created_at)}</td>
          <td>${statusBadge(order.status)}</td>
          ${withActions ? `
          <td>
            ${
              statusKey === 'pending'
                ? `
            <button class="btn btn-sm btn-success w-100 mb-1 btn-confirm" data-id="${order.id}">
              Confirm Payment & Deliver
            </button>
            <button class="btn btn-sm btn-outline-danger w-100 btn-cancel" data-id="${order.id}">
              Cancel
            </button>`
                : '<span class="text-muted small">No actions</span>'
            }
          </td>` : ''}
        `;
        tbodyEl.appendChild(tr);
      });

      if (withActions && statusKey === 'pending') {
        tbodyEl.querySelectorAll('.btn-confirm').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            await confirmAndDeliverOrder(id);
          });
        });

        tbodyEl.querySelectorAll('.btn-cancel').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            await cancelOrder(id);
          });
        });
      }
    }

    // ==============================
    // STOCK LOOKUP + DELIVERY LOGIC
    // ==============================

    async function findAvailableStockForOrder(order) {
      // Adjust column names here if iba sa stocks table mo
      const { data, error } = await supabase
        .from('stocks')
        .select('id, product_id, product_name, account_type, duration, email, password, profile, pin, status, created_at')
        .eq('product_id', order.product_id)
        .eq('account_type', order.account_type)
        .eq('duration', order.duration)
        .or('status.is.null,status.eq.available') // treat NULL or 'available' as usable
        .order('created_at', { ascending: true })
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error('Error finding stock:', error);
        showToast('Error finding stock for this order', 'error');
        return null;
      }
      return data;
    }

    async function createRecordFromStock(order, stock) {
      // Adjust field list if iba ang columns sa records table
      const record = {
        order_id: order.id,
        buyer_email: order.buyer_email,
        product_name: stock.product_name || order.product_name,
        account_type: stock.account_type || order.account_type,
        duration: stock.duration || order.duration,
        price: order.price,
        purchase_date: new Date().toISOString(),
        email: stock.email,
        password: stock.password,
        profile: stock.profile || null,
        pin: stock.pin || null
      };

      const { data, error } = await supabase
        .from('records')
        .insert(record)
        .select('id')
        .maybeSingle();

      if (error) {
        console.error('Error creating record:', error);
        showToast('Error creating delivered record', 'error');
        return null;
      }
      return data;
    }

    async function markStockAsUsed(stockId) {
      // Adjust column names kung iba sa schema mo
      const { error } = await supabase
        .from('stocks')
        .update({
          status: 'used',
          updated_at: new Date().toISOString()
        })
        .eq('id', stockId);

      if (error) {
        console.error('Error marking stock as used:', error);
        showToast('Error updating stock status', 'error');
        return false;
      }
      return true;
    }

    async function setOrderStatus(orderId, newStatus) {
      const { error } = await supabase
        .from('orders')
        .update({ status: newStatus })
        .eq('id', orderId);

      if (error) {
        console.error('Error updating order:', error);
        showToast('Error updating order status', 'error');
        return false;
      }
      return true;
    }

    // ==============================
    // ADMIN ACTIONS
    // ==============================
    async function confirmAndDeliverOrder(orderId) {
      try {
        const order = ALL_ORDERS.find(o => o.id === orderId);
        if (!order) {
          showToast('Order not found in memory', 'error');
          return;
        }

        // 1. Find a matching stock
        const stock = await findAvailableStockForOrder(order);
        if (!stock) {
          showToast('No available stock for this order (check stocks table)', 'warning');
          return;
        }

        // 2. Create delivered record
        const rec = await createRecordFromStock(order, stock);
        if (!rec) return;

        // 3. Mark stock as used
        const stockUpdated = await markStockAsUsed(stock.id);
        if (!stockUpdated) return;

        // 4. Update order -> delivered
        const orderUpdated = await setOrderStatus(orderId, 'delivered');
        if (!orderUpdated) return;

        showToast(`Order ${orderId} confirmed and delivered.`, 'success');
        await loadOrders();
      } catch (err) {
        console.error('confirmAndDeliverOrder error:', err);
        showToast('Unexpected error while delivering order', 'error');
      }
    }

    async function cancelOrder(orderId) {
      try {
        const ok = await setOrderStatus(orderId, 'cancelled');
        if (!ok) return;
        showToast(`Order ${orderId} has been cancelled.`, 'success');
        await loadOrders();
      } catch (err) {
        console.error('cancelOrder error:', err);
        showToast('Unexpected error while cancelling order', 'error');
      }
    }

    // ==============================
    // INIT
    // ==============================
    document.addEventListener('DOMContentLoaded', () => {
      loadOrders();
    });
  </script>
</body>
</html>