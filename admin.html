<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Aiaxcart Premium | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap / Icons / Supabase -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary: #FFB0B5;
      --secondary: #FFD3D6;
      --dark: #382f2c;
      --light: #fefaf7;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light);
      color: var(--dark);
    }

    header {
      background: var(--secondary);
      box-shadow: 0 4px 18px rgba(0,0,0,0.06);
    }

    .logo {
      font-weight: 700;
      font-size: 1.6rem;
      display: flex;
      align-items: center;
      gap: .5rem;
      color: var(--dark);
    }

    .logo span {
      color: var(--primary);
    }

    .stat-card {
      border-radius: 16px;
      padding: 1rem 1.2rem;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    .stat-label {
      font-size: .85rem;
      color: #7c6a63;
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: .2rem;
    }

    .stat-value {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .badge-status {
      border-radius: 999px;
      padding: 4px 10px;
      font-size: .75rem;
      font-weight: 600;
    }

    .badge-pending { background:#fff3cd; color:#856404; }
    .badge-confirmed { background:#d1ecf1; color:#0c5460; }
    .badge-delivered { background:#d4edda; color:#155724; }
    .badge-cancelled { background:#f8d7da; color:#721c24; }

    .nav-pills .nav-link {
      border-radius: 999px;
    }

    .nav-pills .nav-link.active {
      background-color: var(--primary);
    }

    .table thead th {
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .05em;
      color: #7c6a63;
    }

    .table tbody td {
      vertical-align: middle;
      font-size: .9rem;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
      min-width: 260px;
    }

    @media (max-width: 768px) {
      .stat-card {
        margin-bottom: .75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Toast container -->
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- HEADER -->
  <header class="py-3 mb-4">
    <div class="container d-flex justify-content-between align-items-center">
      <div class="logo">
        <i class="fas fa-crown"></i>
        <span>Aiaxcart</span> Premium Admin
      </div>
      <a href="index.html" class="btn btn-outline-dark btn-sm">
        <i class="fas fa-store me-1"></i>Buyer Site
      </a>
    </div>
  </header>

  <main class="container mb-5">
    <!-- ANALYTICS -->
    <section class="mb-4">
      <div class="row g-3" id="analyticsRow">
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-label">Total Orders</div>
            <div class="stat-value" id="totalOrders">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-label">Pending</div>
            <div class="stat-value text-warning" id="pendingOrders">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-label">Confirmed</div>
            <div class="stat-value text-info" id="confirmedOrders">0</div>
          </div>
        </div>
        <div class="col-6 col-md-3">
          <div class="stat-card">
            <div class="stat-label">Delivered</div>
            <div class="stat-value text-success" id="deliveredOrders">0</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ORDERS TABS -->
    <section class="mb-5">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Orders</h4>
      </div>

      <ul class="nav nav-pills mb-3" id="ordersTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-pending" data-bs-toggle="pill"
                  data-bs-target="#pane-pending" type="button" role="tab">
            Pending
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-confirmed" data-bs-toggle="pill"
                  data-bs-target="#pane-confirmed" type="button" role="tab">
            Confirmed
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-delivered" data-bs-toggle="pill"
                  data-bs-target="#pane-delivered" type="button" role="tab">
            Delivered
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-cancelled" data-bs-toggle="pill"
                  data-bs-target="#pane-cancelled" type="button" role="tab">
            Cancelled
          </button>
        </li>
      </ul>

      <div class="tab-content" id="ordersTabContent">
        <!-- Pending -->
        <div class="tab-pane fade show active" id="pane-pending" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Order Code</th>
                  <th>Buyer</th>
                  <th>Product</th>
                  <th>Type / Duration</th>
                  <th>Price</th>
                  <th>Payment</th>
                  <th>Ref No.</th>
                  <th>Created</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="tblPending"></tbody>
            </table>
          </div>
        </div>

        <!-- Confirmed -->
        <div class="tab-pane fade" id="pane-confirmed" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Order Code</th>
                  <th>Buyer</th>
                  <th>Product</th>
                  <th>Type / Duration</th>
                  <th>Price</th>
                  <th>Payment</th>
                  <th>Ref No.</th>
                  <th>Created</th>
                  <th>Status</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="tblConfirmed"></tbody>
            </table>
          </div>
        </div>

        <!-- Delivered -->
        <div class="tab-pane fade" id="pane-delivered" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Order Code</th>
                  <th>Buyer</th>
                  <th>Product</th>
                  <th>Type / Duration</th>
                  <th>Price</th>
                  <th>Payment</th>
                  <th>Ref No.</th>
                  <th>Created</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tblDelivered"></tbody>
            </table>
          </div>
        </div>

        <!-- Cancelled -->
        <div class="tab-pane fade" id="pane-cancelled" role="tabpanel">
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Order Code</th>
                  <th>Buyer</th>
                  <th>Product</th>
                  <th>Type / Duration</th>
                  <th>Price</th>
                  <th>Payment</th>
                  <th>Ref No.</th>
                  <th>Created</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tblCancelled"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- STOCKS SECTION (ADD STOCK + LIST) -->
    <section>
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Stocks</h4>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <form id="addStockForm" class="row g-2">
            <div class="col-md-3">
              <label class="form-label small mb-1">Product</label>
              <select id="stockProductId" class="form-select form-select-sm" required></select>
            </div>
            <div class="col-md-3">
              <label class="form-label small mb-1">Product Name</label>
              <input type="text" id="stockProductName" class="form-control form-control-sm" placeholder="Auto-filled" readonly>
            </div>
            <div class="col-md-2">
              <label class="form-label small mb-1">Account Type</label>
              <select id="stockAccountType" class="form-select form-select-sm" required></select>
            </div>
            <div class="col-md-2">
              <label class="form-label small mb-1">Duration</label>
              <select id="stockDuration" class="form-select form-select-sm" required></select>
            </div>
            <div class="col-md-2">
              <label class="form-label small mb-1">Login Email</label>
              <input type="text" id="stockEmail" class="form-control form-control-sm" placeholder="email for account" required>
            </div>
            <div class="col-md-2">
              <label class="form-label small mb-1">Password</label>
              <input type="text" id="stockPassword" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-2">
              <label class="form-label small mb-1">Profile (optional)</label>
              <input type="text" id="stockProfile" class="form-control form-control-sm" placeholder="Profile 1">
            </div>
            <div class="col-md-2">
              <label class="form-label small mb-1">PIN (optional)</label>
              <input type="text" id="stockPin" class="form-control form-control-sm" placeholder="PIN">
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-sm btn-primary w-100" type="submit">
                <i class="fas fa-plus me-1"></i>Add Stock
              </button>
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <small class="text-muted">
                Inserts into <strong>stocks</strong> table with status <code>available</code>.  
                Columns used: product_id, product_name, account_type, duration, email, password, profile, pin, status, created_at.
              </small>
            </div>
          </form>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th>
              <th>Product</th>
              <th>Type / Duration</th>
              <th>Login</th>
              <th>Status</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody id="tblStocks"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==============================
    // SUPABASE CONFIG (same as index)
    // ==============================
    const SUPABASE_URL = 'https://hnymqvkfmythdxtjqeam.supabase.co';
    const SUPABASE_ANON_KEY =
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhueW1xdmtmbXl0aGR4dGpxZWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjE3NTUsImV4cCI6MjA3ODY5Nzc1NX0.4ww5fKNnbhNzNrkJZLa466b6BsKE_yYMO2YH6-auFlI';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let ALL_ORDERS = [];

    // DROPDOWN OPTIONS (static – pareho dapat sa buyer side IDs)
    const PRODUCT_OPTIONS = [
      { id: 'netflix',            label: 'Netflix Premium' },
      { id: 'viu',                label: 'Viu Premium' },
      { id: 'viva-max',           label: 'VIVAMAX / VIVAONE' },
      { id: 'wetv',               label: 'WeTV' },
      { id: 'iwant-tfc',          label: 'IWANT TFC' },
      { id: 'crunchyroll',        label: 'Crunchyroll' },
      { id: 'disney-plus',        label: 'Disney+' },
      { id: 'bilibili',           label: 'Bilibili' },
      { id: 'loklok',             label: 'Loklok' },
      { id: 'iqiyi',              label: 'iQiyi' },
      { id: 'hbo-max',            label: 'HBO Max' },
      { id: 'amazon-prime',       label: 'Amazon Prime' },
      { id: 'youku',              label: 'Youku' },
      { id: 'nba-league-pass',    label: 'NBA League Pass Premium' },
      { id: 'youtube',            label: 'YouTube Premium' },
      { id: 'spotify',            label: 'Spotify Premium' },
      { id: 'apple-music',        label: 'Apple Music' },
      { id: 'chatgpt',            label: 'ChatGPT Plus' },
      { id: 'blackbox-ai',        label: 'Blackbox AI' },
      { id: 'perplexity',         label: 'Perplexity AI' },
      { id: 'google-one',         label: 'Google One + Gemini' },
      { id: 'quizlet',            label: 'Quizlet+' },
      { id: 'scribd',             label: 'Scribd Premium' },
      { id: 'studocu',            label: 'Studocu Premium' },
      { id: 'duolingo',           label: 'Duolingo Super' },
      { id: 'turnitin-student',   label: 'Turnitin Student' },
      { id: 'turnitin-instructor',label: 'Turnitin Instructor' },
      { id: 'canva',              label: 'Canva Pro' },
      { id: 'picsart',            label: 'Picsart Gold' },
      { id: 'capcut',             label: 'CapCut Pro' },
      { id: 'alight-motion',      label: 'Alight Motion Pro' },
      { id: 'remini',             label: 'Remini Web' },
      { id: 'grammarly',          label: 'Grammarly Premium' },
      { id: 'quillbot',           label: 'Quillbot Premium' },
      { id: 'ms-365',             label: 'Microsoft 365' },
      { id: 'cams-canner',        label: 'CamScanner Pro' },
      { id: 'small-pdf',          label: 'Small PDF Pro' },
      { id: 'zoom',               label: 'Zoom Pro' }
    ];

    const ACCOUNT_TYPE_OPTIONS = [
      'solo account',
      'shared account',
      'solo profile',
      'shared profile',
      'famhead',
      'solo',
      'invite',
      'edu lifetime',
      'teamhead',
      'teamhead account',
      'solo fw',
      'solo nw'
    ];

    const DURATION_OPTIONS = [
      '7d',
      '14d',
      '1m',
      '2m',
      '3m',
      '4m',
      '5m',
      '6m',
      '8m',
      '10m',
      '12m',
      '24m',
      'nw',
      '3m w',
      '6m w',
      '12m w'
    ];

    // ==============================
    // UTILITIES
    // ==============================
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const bsType = type === 'error' ? 'danger' : type;
      toast.className = `toast align-items-center text-bg-${bsType} border-0`;
      toast.setAttribute('role', 'alert');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      document.getElementById('toastContainer').appendChild(toast);
      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();
      toast.addEventListener('hidden.bs.toast', () => toast.remove());
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const d = new Date(dateString);
      if (isNaN(d.getTime())) return dateString;
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function statusBadge(status) {
      const s = (status || '').toLowerCase();
      let cls = 'badge-status badge-secondary';
      if (s === 'pending') cls = 'badge-status badge-pending';
      else if (s === 'confirmed') cls = 'badge-status badge-confirmed';
      else if (s === 'delivered') cls = 'badge-status badge-delivered';
      else if (s === 'cancelled') cls = 'badge-status badge-cancelled';
      return `<span class="${cls} text-capitalize">${s || '-'}</span>`;
    }

    // ==============================
    // LOAD ORDERS
    // ==============================
    async function loadOrders() {
      try {
        const { data, error } = await supabase
          .from('orders')
          .select('id, order_code, buyer_email, product_id, product_name, account_type, duration, price, payment_method, reference_number, invite_email, status, created_at')
          .order('created_at', { ascending: false });

        if (error) {
          console.error('Error loading orders:', error);
          showToast('Error loading orders from database', 'error');
          return;
        }

        ALL_ORDERS = data || [];
        updateAnalytics();
        renderAllOrderTables();
      } catch (err) {
        console.error('loadOrders error:', err);
        showToast('Unexpected error loading orders', 'error');
      }
    }

    function updateAnalytics() {
      const total = ALL_ORDERS.length;
      const pending = ALL_ORDERS.filter(o => (o.status || '').toLowerCase() === 'pending').length;
      const confirmed = ALL_ORDERS.filter(o => (o.status || '').toLowerCase() === 'confirmed').length;
      const delivered = ALL_ORDERS.filter(o => (o.status || '').toLowerCase() === 'delivered').length;

      document.getElementById('totalOrders').textContent = total;
      document.getElementById('pendingOrders').textContent = pending;
      document.getElementById('confirmedOrders').textContent = confirmed;
      document.getElementById('deliveredOrders').textContent = delivered;
    }

    function renderAllOrderTables() {
      renderOrdersByStatus('pending',   document.getElementById('tblPending'),   11, true);
      renderOrdersByStatus('confirmed', document.getElementById('tblConfirmed'), 11, false);
      renderOrdersByStatus('delivered', document.getElementById('tblDelivered'), 10, false);
      renderOrdersByStatus('cancelled', document.getElementById('tblCancelled'), 10, false);
    }

    function renderOrdersByStatus(statusKey, tbodyEl, colCount, withActions) {
      tbodyEl.innerHTML = '';

      const rows = ALL_ORDERS.filter(
        o => (o.status || '').toLowerCase() === statusKey.toLowerCase()
      );

      if (!rows.length) {
        tbodyEl.innerHTML = `
          <tr>
            <td colspan="${colCount}" class="text-center text-muted py-3">
              No ${statusKey} orders.
            </td>
          </tr>
        `;
        return;
      }

      rows.forEach(order => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${order.id}</td>
          <td>${order.order_code || '-'}</td>
          <td>
            <div class="fw-semibold small">${order.buyer_email || '-'}</div>
            ${order.invite_email ? `<div class="small text-muted">Invite: ${order.invite_email}</div>` : ''}
          </td>
          <td>${order.product_name || '-'}</td>
          <td>
            <div class="small">${order.account_type || '-'}</div>
            <div class="small text-muted">${order.duration || '-'}</div>
          </td>
          <td>₱${order.price ?? 0}</td>
          <td class="small text-capitalize">${order.payment_method || '-'}</td>
          <td class="small">${order.reference_number || '-'}</td>
          <td class="small">${formatDate(order.created_at)}</td>
          <td>${statusBadge(order.status)}</td>
          ${withActions ? `
          <td>
            ${
              statusKey === 'pending'
                ? `
            <button class="btn btn-sm btn-success w-100 mb-1 btn-confirm" data-id="${order.id}">
              Confirm Payment & Deliver
            </button>
            <button class="btn btn-sm btn-outline-danger w-100 btn-cancel" data-id="${order.id}">
              Cancel
            </button>`
                : '<span class="text-muted small">No actions</span>'
            }
          </td>` : ''}
        `;
        tbodyEl.appendChild(tr);
      });

      if (withActions && statusKey === 'pending') {
        tbodyEl.querySelectorAll('.btn-confirm').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            await confirmAndDeliverOrder(id);
          });
        });

        tbodyEl.querySelectorAll('.btn-cancel').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            await cancelOrder(id);
          });
        });
      }
    }

    // ==============================
    // STOCK LOOKUP + DELIVERY LOGIC
    // ==============================
    async function findAvailableStockForOrder(order) {
      const { data, error } = await supabase
        .from('stocks')
        .select('id, product_id, product_name, account_type, duration, email, password, profile, pin, status, created_at')
        .eq('product_id', order.product_id)
        .eq('account_type', order.account_type)
        .eq('duration', order.duration)
        .or('status.is.null,status.eq.available')
        .order('created_at', { ascending: true })
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error('Error finding stock:', error);
        showToast('Error finding stock for this order', 'error');
        return null;
      }
      return data;
    }

    async function createRecordFromStock(order, stock) {
      const record = {
        order_id: order.id,
        buyer_email: order.buyer_email,
        product_name: stock.product_name || order.product_name,
        account_type: stock.account_type || order.account_type,
        duration: stock.duration || order.duration,
        price: order.price,
        purchase_date: new Date().toISOString(),
        email: stock.email,
        password: stock.password,
        profile: stock.profile || null,
        pin: stock.pin || null
      };

      const { data, error } = await supabase
        .from('records')
        .insert(record)
        .select('id')
        .maybeSingle();

      if (error) {
        console.error('Error creating record:', error);
        showToast('Error creating delivered record', 'error');
        return null;
      }
      return data;
    }

    async function markStockAsUsed(stockId) {
      const { error } = await supabase
        .from('stocks')
        .update({
          status: 'used',
          updated_at: new Date().toISOString()
        })
        .eq('id', stockId);

      if (error) {
        console.error('Error updating stock status:', error);
        showToast('Error updating stock status', 'error');
        return false;
      }
      return true;
    }

    async function setOrderStatus(orderId, newStatus) {
      const { error } = await supabase
        .from('orders')
        .update({ status: newStatus })
        .eq('id', orderId);

      if (error) {
        console.error('Error updating order status:', error);
        showToast('Error updating order status', 'error');
        return false;
      }
      return true;
    }

    // ==============================
    // ADMIN ACTIONS
    // ==============================
    async function confirmAndDeliverOrder(orderId) {
      try {
        const order = ALL_ORDERS.find(o => o.id === orderId);
        if (!order) {
          showToast('Order not found in memory', 'error');
          return;
        }

        const stock = await findAvailableStockForOrder(order);
        if (!stock) {
          showToast('Cannot confirm: no available stock for this product / type / duration.', 'warning');
          return;
        }

        const rec = await createRecordFromStock(order, stock);
        if (!rec) return;

        const stockUpdated = await markStockAsUsed(stock.id);
        if (!stockUpdated) return;

        const orderUpdated = await setOrderStatus(orderId, 'delivered');
        if (!orderUpdated) return;

        showToast(`Order ${orderId} confirmed and delivered.`, 'success');
        await loadOrders();
        await loadStocks();
      } catch (err) {
        console.error('confirmAndDeliverOrder error:', err);
        showToast('Unexpected error while delivering order', 'error');
      }
    }

    async function cancelOrder(orderId) {
      try {
        const ok = await setOrderStatus(orderId, 'cancelled');
        if (!ok) return;
        showToast(`Order ${orderId} has been cancelled.`, 'success');
        await loadOrders();
      } catch (err) {
        console.error('cancelOrder error:', err);
        showToast('Unexpected error while cancelling order', 'error');
      }
    }

    // ==============================
    // STOCKS: LOAD + ADD
    // ==============================
    async function loadStocks() {
      try {
        const { data, error } = await supabase
          .from('stocks')
          .select('id, product_id, product_name, account_type, duration, email, status, created_at')
          .order('created_at', { ascending: false });

        const tbody = document.getElementById('tblStocks');
        if (error) {
          console.error('Error loading stocks:', error);
          showToast('Error loading stocks', 'error');
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Failed to load stocks.</td></tr>';
          return;
        }

        if (!data || !data.length) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No stocks yet.</td></tr>';
          return;
        }

        tbody.innerHTML = '';
        data.forEach(s => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${s.id}</td>
            <td>
              <div class="small fw-semibold">${s.product_name || '-'}</div>
              <div class="small text-muted">${s.product_id || '-'}</div>
            </td>
            <td>
              <div class="small">${s.account_type || '-'}</div>
              <div class="small text-muted">${s.duration || '-'}</div>
            </td>
            <td class="small">${s.email || '-'}</td>
            <td class="small text-capitalize">${(s.status || 'available')}</td>
            <td class="small">${formatDate(s.created_at)}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('loadStocks error:', err);
        showToast('Unexpected error loading stocks', 'error');
      }
    }

    async function handleAddStock(e) {
      e.preventDefault();

      const product_id   = document.getElementById('stockProductId').value.trim();
      const product_name = document.getElementById('stockProductName').value.trim() || null;
      const account_type = document.getElementById('stockAccountType').value.trim();
      const duration     = document.getElementById('stockDuration').value.trim();
      const email        = document.getElementById('stockEmail').value.trim();
      const password     = document.getElementById('stockPassword').value.trim();
      const profile      = document.getElementById('stockProfile').value.trim() || null;
      const pin          = document.getElementById('stockPin').value.trim() || null;

      if (!product_id || !account_type || !duration || !email || !password) {
        showToast('Please fill in all required fields for stock', 'warning');
        return;
      }

      const payload = {
        product_id,
        product_name,
        account_type,
        duration,
        email,
        password,
        profile,
        pin,
        status: 'available',
        created_at: new Date().toISOString()
      };

      try {
        const { error } = await supabase
          .from('stocks')
          .insert(payload);

        if (error) {
          console.error('Error adding stock:', error);
          showToast('Error adding stock (check columns in stocks table)', 'error');
          return;
        }

        showToast('Stock added successfully.', 'success');
        (document.getElementById('addStockForm')).reset();
        populateStockFormOptions(); // refill default dropdown values
        await loadStocks();
      } catch (err) {
        console.error('handleAddStock error:', err);
        showToast('Unexpected error adding stock', 'error');
      }
    }

    // ==============================
    // INIT DROPDOWNS
    // ==============================
    function populateStockFormOptions() {
      const productSelect = document.getElementById('stockProductId');
      const accountTypeSelect = document.getElementById('stockAccountType');
      const durationSelect = document.getElementById('stockDuration');
      const productNameInput = document.getElementById('stockProductName');

      // products
      productSelect.innerHTML = '<option value="">Select product</option>';
      PRODUCT_OPTIONS.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.label;
        productSelect.appendChild(opt);
      });

      // account types
      accountTypeSelect.innerHTML = '<option value="">Select account type</option>';
      ACCOUNT_TYPE_OPTIONS.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t;
        opt.textContent = t;
        accountTypeSelect.appendChild(opt);
      });

      // durations
      durationSelect.innerHTML = '<option value="">Select duration</option>';
      DURATION_OPTIONS.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d;
        opt.textContent = d;
        durationSelect.appendChild(opt);
      });

      // auto-fill product name when product changes
      productSelect.addEventListener('change', () => {
        const chosen = PRODUCT_OPTIONS.find(p => p.id === productSelect.value);
        productNameInput.value = chosen ? chosen.label : '';
      });
    }

    // ==============================
    // INIT
    // ==============================
    document.addEventListener('DOMContentLoaded', () => {
      populateStockFormOptions();
      loadOrders();
      loadStocks();

      const addStockForm = document.getElementById('addStockForm');
      if (addStockForm) {
        addStockForm.addEventListener('submit', handleAddStock);
      }
    });
  </script>
</body>
</html>