<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Aiaxcart Premium | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Bootstrap + Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  />

  <style>
    :root {
      --primary: #ff6b6b;
      --secondary: #ffd3d6;
      --dark: #382f2c;
      --light: #fefaf7;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: linear-gradient(135deg, #fefaf7 0%, #fff5f5 100%);
      color: var(--dark);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
    }

    header {
      background: var(--secondary);
      box-shadow: 0 4px 20px rgba(255, 107, 107, 0.15);
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
    }

    .header-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 1.5rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--dark);
    }

    .logo span:first-child {
      font-size: 1.8rem;
    }

    .top-nav a {
      text-decoration: none;
      color: var(--dark);
      margin-left: 1rem;
      padding: 0.5rem 1.3rem;
      border-radius: 50px;
      font-weight: 600;
      background: rgba(255, 255, 255, 0.9);
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .top-nav a.active,
    .top-nav a:hover {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .admin-wrapper {
      max-width: 1200px;
      margin: 2rem auto 3rem;
      padding: 0 1.5rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #fff;
      border-radius: 15px;
      padding: 1.5rem;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
      text-align: center;
      border: 1px solid rgba(255, 107, 107, 0.1);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(135deg, var(--primary) 0%, #ff8e8e 100%);
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(255, 107, 107, 0.15);
    }

    .stat-card h3 {
      margin: 0;
      font-size: 2rem;
      color: var(--primary);
      font-weight: 800;
    }

    .stat-card span {
      font-size: 0.9rem;
      color: var(--dark);
      font-weight: 600;
    }

    .admin-layout {
      display: grid;
      grid-template-columns: 250px minmax(0, 1fr);
      gap: 1.5rem;
      margin-top: 2rem;
      align-items: flex-start;
    }

    .sidebar {
      background: #fff;
      border-radius: 20px;
      padding: 1rem;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
      position: sticky;
      top: 6rem;
      border: 1px solid rgba(255, 107, 107, 0.1);
    }

    .sidebar button {
      width: 100%;
      text-align: left;
      border: none;
      background: transparent;
      padding: 0.8rem 1rem;
      border-radius: 12px;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      color: var(--dark);
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .sidebar button.active {
      background: var(--primary);
      color: #fff;
      transform: translateX(5px);
    }

    .sidebar button i {
      width: 20px;
      text-align: center;
      font-size: 1rem;
    }

    .admin-main {
      min-height: 500px;
    }

    .panel-admin {
      display: none;
    }

    .panel-admin.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card-clean {
      background: #fff;
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(255, 107, 107, 0.1);
    }

    .records-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .records-table th,
    .records-table td {
      border-bottom: 1px solid #eee;
      padding: 0.8rem;
      vertical-align: middle;
    }

    .records-table th {
      background: rgba(255, 107, 107, 0.05);
      font-weight: 700;
      color: var(--dark);
    }

    .records-table tr:hover td {
      background: rgba(255, 107, 107, 0.02);
    }

    .form-label {
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--dark);
    }

    .toast-container {
      z-index: 9999;
    }

    .hidden {
      display: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, #ff8e8e 100%);
      border: none;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    }

    @media (max-width: 900px) {
      .admin-layout {
        grid-template-columns: minmax(0, 1fr);
      }

      .sidebar {
        position: static;
        order: 2;
      }

      .admin-main {
        order: 1;
      }

      .stats-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 600px) {
      .stats-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      
      .header-inner {
        flex-direction: column;
        gap: 1rem;
      }
      
      .top-nav {
        display: flex;
        gap: 0.5rem;
      }
    }
  </style>
</head>

<body>
  <!-- Toasts -->
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <!-- Header -->
  <header>
    <div class="header-inner">
      <div class="logo">
        <span>üõí</span>
        <span>Aiaxcart Premium ‚Äì Admin</span>
      </div>
      <nav class="top-nav">
        <a href="./index.html">Home</a>
        <a href="./admin.html" class="active">Admin</a>
      </nav>
    </div>
  </header>

  <!-- Main Admin Wrapper -->
  <main class="admin-wrapper">
    <!-- ADMIN GATE -->
    <div id="adminGate" class="card-clean mb-3">
      <h2 class="h4 mb-3">üîí Admin Security</h2>
      <p class="text-muted mb-3">
        Enter your admin UID to access the console. Only registered UIDs in the
        <code>admin_uids</code> table are allowed.
      </p>
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label">Admin UID</label>
          <input id="adminUidInput" class="form-control" placeholder="Paste your UID here">
        </div>
        <div class="col-md-3 d-grid">
          <button id="btnAdminLogin" class="btn btn-primary" type="button">
            <i class="fa fa-lock-open me-1"></i> Unlock Console
          </button>
        </div>
        <div class="col-md-3 small text-muted">
          <i class="fa fa-shield me-1"></i>
          Protected access. Contact owner if you need access.
        </div>
      </div>
    </div>

    <div id="adminContent" class="hidden">
      <h1 class="h4 mb-3">Admin Console</h1>

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="stat-products">0</h3>
          <span>Products</span>
        </div>
        <div class="stat-card">
          <h3 id="stat-stock">0</h3>
          <span>Available Stocks</span>
        </div>
        <div class="stat-card">
          <h3 id="stat-pending">0</h3>
          <span>Pending Orders</span>
        </div>
        <div class="stat-card">
          <h3 id="stat-revenue">‚Ç±0.00</h3>
          <span>Total Revenue</span>
        </div>
      </div>

      <div class="admin-layout">
        <!-- Sidebar Tabs -->
        <aside class="sidebar">
          <button class="active" data-target="panel-products">
            <i class="fa fa-list"></i> Products
          </button>
          <button data-target="panel-product-prices">
            <i class="fa fa-tag"></i> Product Prices
          </button>
          <button data-target="panel-add-stock">
            <i class="fa fa-plus-square"></i> Add Stock
          </button>
          <button data-target="panel-manage-stocks">
            <i class="fa fa-layer-group"></i> Stocks List
          </button>
          <button data-target="panel-pending-orders">
            <i class="fa fa-clock"></i> Pending Orders
          </button>
          <button data-target="panel-records">
            <i class="fa fa-book"></i> Sold Accounts
          </button>
          <button data-target="panel-store-rules">
            <i class="fa fa-scroll"></i> Store Rules
          </button>
          <button data-target="panel-reports">
            <i class="fa fa-flag"></i> Reports
          </button>
        </aside>

        <!-- Main panels -->
        <section class="admin-main">

          <!-- Products List -->
          <div id="panel-products" class="panel-admin active">
            <div class="card-clean">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">üì¶ Products</h3>
              </div>

              <!-- Add / Edit Product Form -->
              <div class="mb-4">
                <input type="hidden" id="prod-edit-id">
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">Product ID</label>
                    <input id="new-prod-id" class="form-control" placeholder="e.g. netflix">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Name</label>
                    <input id="new-prod-name" class="form-control" placeholder="Netflix Premium">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <select id="new-prod-cat" class="form-select">
                      <option value="entertainment">Entertainment</option>
                      <option value="streaming">Streaming</option>
                      <option value="educational">Educational</option>
                      <option value="editing">Editing</option>
                      <option value="ai">AI Tools</option>
                    </select>
                  </div>
                  <div class="col-md-2 d-grid">
                    <button id="btn-save-product" class="btn btn-primary" type="button">
                      <i class="fa fa-plus me-1"></i> Add
                    </button>
                  </div>
                </div>
                <div class="mt-2">
                  <button id="btn-cancel-prod-edit" type="button" class="btn btn-link p-0 small d-none">
                    <i class="fa fa-times me-1"></i> Cancel edit
                  </button>
                </div>
                <small class="text-muted">
                  <i class="fa fa-info-circle me-1"></i>
                  Product IDs must match those used on the buyer site.
                </small>
              </div>

              <div class="table-responsive">
                <table class="records-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Name</th>
                      <th>Category</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="products-table-body">
                    <tr>
                      <td colspan="4" class="text-center text-muted py-3">
                        Loading products...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Product Prices -->
          <div id="panel-product-prices" class="panel-admin">
            <div class="card-clean">
              <h3 class="mb-3">üí∞ Product Prices</h3>
              
              <!-- Add Price Form -->
              <div class="mb-4">
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label class="form-label">Product</label>
                    <select id="price-product" class="form-select">
                      <option value="">Select product</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Account Type</label>
                    <select id="price-account-type" class="form-select">
                      <option value="">Select type</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Duration</label>
                    <select id="price-duration" class="form-select">
                      <option value="">Select duration</option>
                    </select>
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Price (‚Ç±)</label>
                    <input id="price-amount" type="number" step="0.01" class="form-control" placeholder="0.00">
                  </div>
                  <div class="col-md-2 d-grid">
                    <button id="btn-add-price" class="btn btn-primary" type="button">
                      <i class="fa fa-plus me-1"></i> Add Price
                    </button>
                  </div>
                </div>
              </div>

              <!-- Prices List -->
              <div class="table-responsive">
                <table class="records-table">
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Account Type</th>
                      <th>Duration</th>
                      <th>Price</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="prices-table-body">
                    <tr>
                      <td colspan="5" class="text-center text-muted py-3">
                        Loading prices...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Add Stock -->
          <div id="panel-add-stock" class="panel-admin">
            <div class="card-clean">
              <h3 class="mb-3">üì• Add Stock</h3>
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Product</label>
                  <select id="stock-product" class="form-select">
                    <option value="">Select product</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Account Type</label>
                  <select id="stock-account-type" class="form-select">
                    <option value="">Select type</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Duration</label>
                  <select id="stock-duration" class="form-select">
                    <option value="">Select duration</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Price (‚Ç±)</label>
                  <input id="stock-price" type="number" step="0.01" class="form-control" placeholder="0.00">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Account Email</label>
                  <input id="stock-email" class="form-control" placeholder="account@email.com">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Password</label>
                  <input id="stock-password" class="form-control" placeholder="Account password">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Profile</label>
                  <input id="stock-profile" class="form-control" placeholder="Profile name">
                </div>

                <div class="col-md-3">
                  <label class="form-label">PIN</label>
                  <input id="stock-pin" class="form-control" placeholder="PIN code">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Archive After (days)</label>
                  <input id="stock-archive-after" type="number" min="0" value="30" class="form-control">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Premium Until</label>
                  <input id="stock-premium-until" type="date" class="form-control">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Quantity (slots)</label>
                  <input id="stock-quantity" type="number" min="1" value="1" class="form-control">
                </div>
              </div>

              <button id="btn-save-stock" class="btn btn-primary mt-3" type="button">
                <i class="fa fa-save me-1"></i> Save Stock
              </button>
              <small class="text-muted d-block mt-2">
                <i class="fa fa-info-circle me-1"></i>
                Each stock entry represents account credentials. Quantity indicates available slots.
              </small>
            </div>
          </div>

          <!-- Stocks List -->
          <div id="panel-manage-stocks" class="panel-admin">
            <div class="card-clean">
              <h3 class="mb-3">üìã Stocks List</h3>
              <div class="table-responsive">
                <table class="records-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Product</th>
                      <th>Account Type</th>
                      <th>Duration</th>
                      <th>Email</th>
                      <th>Status</th>
                      <th>Premium Until</th>
                      <th>Price</th>
                      <th>Qty</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="stocks-table-body">
                    <tr>
                      <td colspan="10" class="text-center text-muted py-3">
                        Loading stocks...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Pending Orders -->
          <div id="panel-pending-orders" class="panel-admin">
            <div class="card-clean">
              <h3 class="mb-3">‚è≥ Pending Orders</h3>
              <div class="table-responsive">
                <table class="records-table">
                  <thead>
                    <tr>
                      <th>Order ID</th>
                      <th>Buyer</th>
                      <th>Product</th>
                      <th>Type</th>
                      <th>Duration</th>
                      <th>Price</th>
                      <th>Payment</th>
                      <th>Proof</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="orders-table-body">
                    <tr>
                      <td colspan="10" class="text-center text-muted py-3">
                        Loading pending orders...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Records (Sold Accounts) -->
          <div id="panel-records" class="panel-admin">
            <div class="card-clean">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0">‚úÖ Sold Accounts</h3>
                <div>
                  <button id="btn-add-record" class="btn btn-sm btn-outline-primary me-2" type="button">
                    <i class="fa fa-plus me-1"></i> Add Manual Record
                  </button>
                  <button id="btn-export-records" class="btn btn-sm btn-outline-secondary" type="button">
                    <i class="fa fa-download me-1"></i> Export CSV
                  </button>
                </div>
              </div>
              <div class="table-responsive">
                <table class="records-table">
                  <thead>
                    <tr>
                      <th>Record ID</th>
                      <th>Order ID</th>
                      <th>Buyer</th>
                      <th>Product</th>
                      <th>Type</th>
                      <th>Duration</th>
                      <th>Purchase Date</th>
                      <th>Expiry</th>
                      <th>+Days</th>
                      <th>Updated Expiry</th>
                      <th>Price</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="records-table-body">
                    <tr>
                      <td colspan="12" class="text-center text-muted py-3">
                        Loading records...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Store Rules -->
          <div id="panel-store-rules" class="panel-admin">
            <div class="card-clean">
              <h3 class="mb-3">üìú Store Rules</h3>
              <p class="text-muted mb-3">
                Manage rules in the <code>rules</code> table. Rules can be general or linked to a specific product.
              </p>

              <div class="row g-2 mb-3">
                <div class="col-md-3">
                  <label class="form-label">Product ID</label>
                  <select id="rule-product-id" class="form-select">
                    <option value="">General Rule</option>
                  </select>
                </div>
                <div class="col-md-7">
                  <label class="form-label">Rule Text</label>
                  <input id="rule-text" class="form-control" placeholder="Enter rule text...">
                </div>
                <div class="col-md-2 d-grid">
                  <button id="btn-add-rule" class="btn btn-primary" type="button">
                    <i class="fa fa-plus me-1"></i> Add Rule
                  </button>
                </div>
              </div>

              <ul id="rules-list" class="list-unstyled mb-0">
                <li class="text-center text-muted py-3">Loading rules...</li>
              </ul>
            </div>
          </div>

          <!-- Reports -->
          <div id="panel-reports" class="panel-admin">
            <div class="card-clean">
              <h3 class="mb-3">üö© Reports</h3>
              <p class="text-muted mb-3">
                This panel shows all reports from the <code>reports</code> table.
              </p>
              <div class="table-responsive">
                <table class="records-table">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Order ID</th>
                      <th>Buyer ID</th>
                      <th>Issue</th>
                      <th>Status</th>
                      <th>Created At</th>
                    </tr>
                  </thead>
                  <tbody id="reports-table-body">
                    <tr>
                      <td colspan="6" class="text-center text-muted py-3">
                        Loading reports...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

        </section>
      </div>
    </div>
  </main>

  <!-- STOCK EDIT MODAL -->
  <div class="modal fade" id="stockModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">‚úèÔ∏è Edit Stock</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="stockForm">
            <input type="hidden" id="stock-edit-id">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input id="stock-edit-email" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input id="stock-edit-password" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Profile</label>
              <input id="stock-edit-profile" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">PIN</label>
              <input id="stock-edit-pin" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Price (‚Ç±)</label>
              <input id="stock-edit-price" type="number" step="0.01" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Status</label>
              <select id="stock-edit-status" class="form-select">
                <option value="available">available</option>
                <option value="sold">sold</option>
                <option value="archived">archived</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Premium Until</label>
              <input id="stock-edit-premium" type="date" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Quantity (slots)</label>
              <input id="stock-edit-qty" type="number" min="0" class="form-control">
            </div>
            <button class="btn btn-primary w-100 mt-2" type="submit">
              <i class="fa fa-save me-1"></i> Save changes
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- MANUAL RECORD / EDIT MODAL -->
  <div class="modal fade" id="recordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="recordModalTitle">üìù Add Manual Record</h5>
          <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="recordForm">
            <input type="hidden" id="rec-id">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Order ID (optional)</label>
                <input id="rec-order-id" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Buyer (email)</label>
                <input id="rec-buyer" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Source</label>
                <select id="rec-source" class="form-select" required>
                  <option value="manual">manual</option>
                  <option value="premium-shop">premium-shop</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Product ID</label>
                <select id="rec-product-id" class="form-select" required>
                  <option value="">Select product</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Account Type</label>
                <select id="rec-account-type" class="form-select">
                  <option value="">Select type</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Duration</label>
                <select id="rec-duration" class="form-select">
                  <option value="">Select duration</option>
                </select>
              </div>

              <div class="col-md-4">
                <label class="form-label">Purchase Date</label>
                <input id="rec-purchase-date" type="date" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Expiry Date</label>
                <input id="rec-expiry-date" type="date" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Additional Days</label>
                <input id="rec-additional-days" type="number" min="0" class="form-control" placeholder="0">
              </div>

              <div class="col-md-4">
                <label class="form-label">Price (‚Ç±)</label>
                <input id="rec-price" type="number" step="0.01" min="0" class="form-control">
              </div>

              <div class="col-md-4">
                <label class="form-label">Account Email (optional)</label>
                <input id="rec-account-email" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Password (optional)</label>
                <input id="rec-account-password" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">Profile (optional)</label>
                <input id="rec-profile" class="form-control">
              </div>
              <div class="col-md-4">
                <label class="form-label">PIN (optional)</label>
                <input id="rec-pin" class="form-control">
              </div>
            </div>

            <button class="btn btn-primary w-100 mt-3" type="submit">
              <i class="fa fa-save me-1"></i> Save Record
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Supabase JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ========= CONFIG =========
    const SUPABASE_URL = "https://hnymqvkfmythdxtjqeam.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhueW1xdmtmbXl0aGR4dGpxZWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjE3NTUsImV4cCI6MjA3ODY5Nzc1NX0.4ww5fKNnbhNzNrkJZLa466b6BsKE_yYMO2YH6-auFlI";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const ADMIN_ALLOW_UIDS = [
      "5196f372-803a-4aec-9c46-72242e73a9b8"
    ];

    // Global variables for dropdown data
    let allAccountTypes = [];
    let allDurations = [];

    function showToast(message, type = "info") {
      const container = document.getElementById("toastContainer");
      if (!container) return;

      const wrapper = document.createElement("div");
      const bsType =
        type === "success" ? "success" :
        type === "danger" || type === "error" ? "danger" :
        type === "warning" ? "warning" : "secondary";

      wrapper.className = `toast align-items-center text-bg-${bsType} border-0`;
      wrapper.role = "alert";
      wrapper.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      container.appendChild(wrapper);
      const toast = new bootstrap.Toast(wrapper);
      toast.show();
      wrapper.addEventListener("hidden.bs.toast", () => wrapper.remove());
    }

    function safeNumber(v) {
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    // ========= DROPDOWN MANAGEMENT =========
    async function loadDropdownData() {
      try {
        // Load account types and durations from stocks
        const { data: stocksData, error: stocksError } = await supabase
          .from("stocks")
          .select("account_type, duration")
          .not("account_type", "is", null)
          .not("duration", "is", null);

        if (stocksError) throw stocksError;

        // Extract unique values
        allAccountTypes = [...new Set(stocksData.map(item => item.account_type))].sort();
        allDurations = [...new Set(stocksData.map(item => item.duration))].sort();

        populateAllDropdowns();
      } catch (err) {
        console.error("[loadDropdownData] error:", err);
      }
    }

    function populateAllDropdowns() {
      // Populate account type dropdowns
      const accountTypeSelectors = [
        "stock-account-type", "price-account-type", "rec-account-type"
      ];
      
      accountTypeSelectors.forEach(selector => {
        const element = document.getElementById(selector);
        if (element) {
          const currentValue = element.value;
          element.innerHTML = '<option value="">Select account type</option>';
          allAccountTypes.forEach(type => {
            const option = document.createElement("option");
            option.value = type;
            option.textContent = type;
            element.appendChild(option);
          });
          if (currentValue) element.value = currentValue;
        }
      });

      // Populate duration dropdowns
      const durationSelectors = [
        "stock-duration", "price-duration", "rec-duration"
      ];
      
      durationSelectors.forEach(selector => {
        const element = document.getElementById(selector);
        if (element) {
          const currentValue = element.value;
          element.innerHTML = '<option value="">Select duration</option>';
          allDurations.forEach(duration => {
            const option = document.createElement("option");
            option.value = duration;
            option.textContent = duration;
            element.appendChild(option);
          });
          if (currentValue) element.value = currentValue;
        }
      });
    }

    // ========= EXPIRY CALCULATION =========
    function calculateExpiryDate(duration, startDate = new Date()) {
      if (!duration) return null;
      
      const date = new Date(startDate);
      const match = duration.match(/(\d+)([dmwy])/);
      if (!match) return null;
      
      const amount = parseInt(match[1]);
      const unit = match[2];
      
      switch(unit) {
        case 'd': date.setDate(date.getDate() + amount); break;
        case 'm': date.setMonth(date.getMonth() + amount); break;
        case 'w': date.setDate(date.getDate() + (amount * 7)); break;
        case 'y': date.setFullYear(date.getFullYear() + amount); break;
      }
      
      return date.toISOString().split('T')[0];
    }

    // ========= ADMIN GATE =========
    async function guardAdmin() {
      const stored = localStorage.getItem("aiax_admin_uid");
      if (stored) {
        document.getElementById("adminGate").classList.add("hidden");
        document.getElementById("adminContent").classList.remove("hidden");
        return true;
      }
      return false;
    }

    // In admin.html, replace the handleAdminLogin function with this:
async function handleAdminLogin() {
  const input = document.getElementById("adminUidInput");
  const uid = (input.value || "").trim();
  
  if (!uid) {
    showToast("‚ùå Please enter admin UID", "warning");
    return;
  }

  try {
    // Simple UID check - you can add more complex validation if needed
    if (uid.length < 10) {
      showToast("‚ùå Invalid UID format", "danger");
      return;
    }

    // Store the UID and unlock
    localStorage.setItem("aiax_admin_uid", uid);
    document.getElementById("adminGate").classList.add("hidden");
    document.getElementById("adminContent").classList.remove("hidden");
    showToast("‚úÖ Admin console unlocked", "success");

    await initialLoads();
  } catch (err) {
    console.error("[adminLogin] error:", err);
    showToast("‚ùå Failed to unlock admin", "danger");
  }
}

    async function initialLoads() {
      showToast("üîÑ Loading admin data...", "info");
      await refreshStats();
      await loadProducts();
      await loadDropdownData();
      await loadProductPrices();
      await loadStocks();
      await loadPendingOrders();
      await loadRecords();
      await loadRules();
      await loadReports();
      showToast("‚úÖ Admin data loaded", "success");
    }

    // ========= STATS =========
    async function refreshStats() {
      try {
        const [
          { data: prodRows },
          { data: stockRows },
          { data: orderRows },
          { data: recRows }
        ] = await Promise.all([
          supabase.from("products").select("id"),
          supabase.from("stocks").select("id, status, quantity"),
          supabase.from("orders").select("id, status"),
          supabase.from("records").select("price"),
        ]);

        const productsCount = prodRows?.length || 0;
        const availableStock = (stockRows || []).filter(
          (s) => (s.status || "").toLowerCase() === "available" && safeNumber(s.quantity) > 0
        ).length;
        const pendingOrders = (orderRows || []).filter(
          (o) => (o.status || "").toLowerCase() === "pending"
        ).length;
        const totalRevenue = (recRows || []).reduce(
          (sum, r) => sum + safeNumber(r.price),
          0
        );

        document.getElementById("stat-products").textContent = productsCount;
        document.getElementById("stat-stock").textContent = availableStock;
        document.getElementById("stat-pending").textContent = pendingOrders;
        document.getElementById("stat-revenue").textContent =
          "‚Ç±" + totalRevenue.toLocaleString("en-PH", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
      } catch (err) {
        console.error("[stats] error:", err);
      }
    }

    // ========= PRODUCTS =========
    async function loadProducts() {
      const tbody = document.getElementById("products-table-body");
      const selectStockProduct = document.getElementById("stock-product");
      const selectPriceProduct = document.getElementById("price-product");
      const selectRuleProduct = document.getElementById("rule-product-id");
      const selectRecordProduct = document.getElementById("rec-product-id");
      
      if (!tbody) return;

      tbody.innerHTML = "";
      
      // Clear and setup dropdowns
      [selectStockProduct, selectPriceProduct, selectRuleProduct, selectRecordProduct].forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">Select product</option>';
        }
      });

      try {
        const { data, error } = await supabase
          .from("products")
          .select("id, name, category")
          .order("name", { ascending: true });

        if (error) throw error;

        if (!data || !data.length) {
          tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No products found</td></tr>';
          return;
        }

        data.forEach((p) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="startEditProduct('${p.id}', '${p.name}', '${p.category}')">
                <i class="fa fa-edit me-1"></i> Edit
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${p.id}')">
                <i class="fa fa-trash me-1"></i> Delete
              </button>
            </td>`;
          tbody.appendChild(tr);

          // Populate dropdowns
          [selectStockProduct, selectPriceProduct, selectRuleProduct, selectRecordProduct].forEach(select => {
            if (select) {
              const opt = document.createElement("option");
              opt.value = p.id;
              opt.textContent = `${p.name} (${p.category})`;
              select.appendChild(opt);
            }
          });
        });
      } catch (err) {
        console.error("[products] error:", err);
        showToast("‚ùå Failed to load products", "danger");
      }
    }

    function startEditProduct(id, name, category) {
      document.getElementById("prod-edit-id").value = id;
      document.getElementById("new-prod-id").value = id;
      document.getElementById("new-prod-id").disabled = true;
      document.getElementById("new-prod-name").value = name || "";
      document.getElementById("new-prod-cat").value = category || "";
      document.getElementById("btn-save-product").innerHTML = '<i class="fa fa-save me-1"></i> Update';
      document.getElementById("btn-cancel-prod-edit").classList.remove("d-none");
      
      // Scroll to form
      document.getElementById("panel-products").scrollIntoView({ behavior: 'smooth' });
    }

    function resetProductForm() {
      document.getElementById("prod-edit-id").value = "";
      document.getElementById("new-prod-id").value = "";
      document.getElementById("new-prod-id").disabled = false;
      document.getElementById("new-prod-name").value = "";
      document.getElementById("new-prod-cat").value = "entertainment";
      document.getElementById("btn-save-product").innerHTML = '<i class="fa fa-plus me-1"></i> Add';
      document.getElementById("btn-cancel-prod-edit").classList.add("d-none");
    }

    async function saveProduct() {
      const editId = document.getElementById("prod-edit-id").value;
      const id = document.getElementById("new-prod-id").value.trim();
      const name = document.getElementById("new-prod-name").value.trim();
      const category = document.getElementById("new-prod-cat").value;

      if (!id || !name || !category) {
        showToast("‚ùå Please fill product id, name, and category", "warning");
        return;
      }

      try {
        if (editId) {
          const { error } = await supabase
            .from("products")
            .update({ name, category })
            .eq("id", editId);
          if (error) throw error;
          showToast("‚úÖ Product updated", "success");
        } else {
          const { error } = await supabase.from("products").insert({
            id,
            name,
            category
          });
          if (error) throw error;
          showToast("‚úÖ Product added", "success");
        }

        resetProductForm();
        await loadProducts();
        await refreshStats();
      } catch (err) {
        console.error("[saveProduct] error:", err);
        showToast("‚ùå Failed to save product", "danger");
      }
    }

    async function deleteProduct(id) {
      if (!confirm(`‚ùì Delete product ${id}? This will also remove related stocks and prices.`)) return;
      try {
        const { error } = await supabase.from("products").delete().eq("id", id);
        if (error) throw error;
        showToast("‚úÖ Product deleted", "success");
        await loadProducts();
        await refreshStats();
      } catch (err) {
        console.error("[deleteProduct] error:", err);
        showToast("‚ùå Failed to delete product", "danger");
      }
    }

    // ========= PRODUCT PRICES =========
    async function loadProductPrices() {
      const tbody = document.getElementById("prices-table-body");
      if (!tbody) return;

      tbody.innerHTML = "";

      try {
        // Get unique price combinations from stocks
        const { data: stocks, error: stocksError } = await supabase
          .from("stocks")
          .select("product_id, account_type, duration, price")
          .order("product_id");

        if (stocksError) throw stocksError;

        // Get product names
        const { data: products, error: productsError } = await supabase
          .from("products")
          .select("id, name");

        if (productsError) throw productsError;

        const productMap = {};
        products.forEach(p => productMap[p.id] = p.name);

        if (!stocks || !stocks.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No prices configured yet</td></tr>';
          return;
        }

        // Get unique combinations
        const uniqueCombos = {};
        stocks.forEach(stock => {
          const key = `${stock.product_id}-${stock.account_type}-${stock.duration}`;
          if (!uniqueCombos[key]) {
            uniqueCombos[key] = stock;
          }
        });

        Object.values(uniqueCombos).forEach(combo => {
          const tr = document.createElement("tr");
          const productName = productMap[combo.product_id] || combo.product_id;
          
          tr.innerHTML = `
            <td>${productName}</td>
            <td>${combo.account_type}</td>
            <td>${combo.duration}</td>
            <td>‚Ç±${safeNumber(combo.price).toFixed(2)}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="editPriceCombo('${combo.product_id}', '${combo.account_type}', '${combo.duration}', ${combo.price})">
                <i class="fa fa-edit me-1"></i> Edit
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deletePriceCombo('${combo.product_id}', '${combo.account_type}', '${combo.duration}')">
                <i class="fa fa-trash me-1"></i> Delete
              </button>
            </td>`;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error("[productPrices] error:", err);
        showToast("‚ùå Failed to load product prices", "danger");
      }
    }

    function editPriceCombo(productId, accountType, duration, price) {
      document.getElementById("price-product").value = productId;
      document.getElementById("price-account-type").value = accountType;
      document.getElementById("price-duration").value = duration;
      document.getElementById("price-amount").value = price;
      
      // Switch to prices panel
      document.querySelectorAll(".sidebar button").forEach(btn => btn.classList.remove("active"));
      document.querySelector('[data-target="panel-product-prices"]').classList.add("active");
      document.querySelectorAll(".panel-admin").forEach(panel => panel.classList.remove("active"));
      document.getElementById("panel-product-prices").classList.add("active");
    }

    async function deletePriceCombo(productId, accountType, duration) {
      if (!confirm(`‚ùì Delete price for ${productId} - ${accountType} - ${duration}?`)) return;
      try {
        // Update all stocks with this combo to have null price
        const { error } = await supabase
          .from("stocks")
          .update({ price: null })
          .eq("product_id", productId)
          .eq("account_type", accountType)
          .eq("duration", duration);

        if (error) throw error;
        showToast("‚úÖ Price deleted", "success");
        await loadProductPrices();
        await loadStocks();
      } catch (err) {
        console.error("[deletePriceCombo] error:", err);
        showToast("‚ùå Failed to delete price", "danger");
      }
    }

    async function addProductPrice() {
      const product_id = document.getElementById("price-product").value;
      const account_type = document.getElementById("price-account-type").value;
      const duration = document.getElementById("price-duration").value;
      const price = Number(document.getElementById("price-amount").value);

      if (!product_id || !account_type || !duration || !price) {
        showToast("‚ùå Please fill all fields", "warning");
        return;
      }

      try {
        // Update all stocks with this combination to have the new price
        const { error } = await supabase
          .from("stocks")
          .update({ price })
          .eq("product_id", product_id)
          .eq("account_type", account_type)
          .eq("duration", duration);

        if (error) throw error;

        showToast("‚úÖ Price updated successfully", "success");
        
        // Clear form
        document.getElementById("price-amount").value = "";
        
        await loadProductPrices();
        await loadStocks();
      } catch (err) {
        console.error("[addProductPrice] error:", err);
        showToast("‚ùå Failed to update price: " + (err.message || String(err)), "danger");
      }
    }

    // ========= STOCKS =========
    async function loadStocks() {
      const tbody = document.getElementById("stocks-table-body");
      if (!tbody) return;
      tbody.innerHTML = "";

      try {
        const [{ data: stocks, error: errStocks }, { data: products, error: errProd }] =
          await Promise.all([
            supabase
              .from("stocks")
              .select("id, product_id, account_type, duration, email, password, profile, pin, status, premium_until, quantity, price")
              .order("created_at", { ascending: false }),
            supabase.from("products").select("id, name"),
          ]);

        if (errStocks) throw errStocks;
        if (errProd) throw errProd;

        const prodMap = {};
        (products || []).forEach((p) => (prodMap[p.id] = p.name));

        if (!stocks || !stocks.length) {
          tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-3">No stocks yet</td></tr>';
          return;
        }

        stocks.forEach((s) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.id}</td>
            <td>${prodMap[s.product_id] || s.product_id || "-"}</td>
            <td>${s.account_type || "-"}</td>
            <td>${s.duration || "-"}</td>
            <td>${s.email || "-"}</td>
            <td><span class="badge ${s.status === 'available' ? 'bg-success' : s.status === 'sold' ? 'bg-secondary' : 'bg-warning'}">${s.status || "-"}</span></td>
            <td>${s.premium_until || "-"}</td>
            <td>‚Ç±${safeNumber(s.price).toFixed(2)}</td>
            <td>${safeNumber(s.quantity)}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" onclick="openStockEditModal(${s.id})">
                <i class="fa fa-edit me-1"></i> Edit
              </button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteStock(${s.id})">
                <i class="fa fa-trash me-1"></i> Delete
              </button>
            </td>`;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("[stocks] error:", err);
        showToast("‚ùå Failed to load stocks", "danger");
      }
    }

    async function deleteStock(id) {
      if (!confirm(`‚ùì Delete stock #${id}?`)) return;
      try {
        const { error } = await supabase.from("stocks").delete().eq("id", id);
        if (error) throw error;
        showToast("‚úÖ Stock deleted", "success");
        await loadStocks();
        await refreshStats();
      } catch (err) {
        console.error("[deleteStock] error:", err);
        showToast("‚ùå Failed to delete stock", "danger");
      }
    }

    async function saveStock() {
      const product_id = document.getElementById("stock-product")?.value || "";
      const account_type = document.getElementById("stock-account-type")?.value || "";
      const duration = document.getElementById("stock-duration")?.value || "";
      const price = Number(document.getElementById("stock-price")?.value || 0);
      const email = document.getElementById("stock-email")?.value.trim() || "";
      const password = document.getElementById("stock-password")?.value.trim() || "";
      const profile = document.getElementById("stock-profile")?.value.trim() || "";
      const pin = document.getElementById("stock-pin")?.value.trim() || "";
      const archive_after = Number(document.getElementById("stock-archive-after")?.value || 0);
      const premium_until = document.getElementById("stock-premium-until")?.value || null;
      const quantity = Number(document.getElementById("stock-quantity")?.value || 1);

      if (!product_id || !account_type || !duration) {
        showToast("‚ùå Please select product, account type, and duration", "warning");
        return;
      }

      try {
        const { error } = await supabase.from("stocks").insert([
          {
            product_id,
            account_type,
            duration,
            price,
            email,
            password,
            profile,
            pin,
            archive_after: Number.isFinite(archive_after) ? archive_after : 0,
            premium_until: premium_until || null,
            status: "available",
            quantity: Number.isFinite(quantity) && quantity > 0 ? quantity : 1,
          },
        ]);

        if (error) throw error;

        showToast("‚úÖ Stock saved!", "success");

        // Clear form
        ["stock-email", "stock-password", "stock-profile", "stock-pin", "stock-price"].forEach(
          (id) => {
            const input = document.getElementById(id);
            if (input) input.value = "";
          }
        );

        await loadStocks();
        await refreshStats();
      } catch (err) {
        console.error("[saveStock] error:", err);
        showToast("‚ùå Failed to save stock", "danger");
      }
    }

    // STOCK EDIT
    async function openStockEditModal(stockId) {
      try {
        const { data: stock, error } = await supabase
          .from("stocks")
          .select("*")
          .eq("id", stockId)
          .single();

        if (error) throw error;

        document.getElementById("stock-edit-id").value = stock.id;
        document.getElementById("stock-edit-email").value = stock.email || "";
        document.getElementById("stock-edit-password").value = stock.password || "";
        document.getElementById("stock-edit-profile").value = stock.profile || "";
        document.getElementById("stock-edit-pin").value = stock.pin || "";
        document.getElementById("stock-edit-price").value = safeNumber(stock.price);
        document.getElementById("stock-edit-status").value = stock.status || "available";
        document.getElementById("stock-edit-premium").value = stock.premium_until ? stock.premium_until.substring(0, 10) : "";
        document.getElementById("stock-edit-qty").value = safeNumber(stock.quantity);

        const m = new bootstrap.Modal(document.getElementById("stockModal"));
        m.show();
      } catch (err) {
        console.error("[openStockEditModal] error:", err);
        showToast("‚ùå Failed to load stock data", "danger");
      }
    }

    async function saveStockEdit(e) {
      e.preventDefault();
      const id = document.getElementById("stock-edit-id").value;
      if (!id) return;

      const email = document.getElementById("stock-edit-email").value.trim() || null;
      const password = document.getElementById("stock-edit-password").value.trim() || null;
      const profile = document.getElementById("stock-edit-profile").value.trim() || null;
      const pin = document.getElementById("stock-edit-pin").value.trim() || null;
      const price = Number(document.getElementById("stock-edit-price").value) || 0;
      const status = document.getElementById("stock-edit-status").value || "available";
      const premium_raw = document.getElementById("stock-edit-premium").value;
      const qtyVal = document.getElementById("stock-edit-qty").value;

      const payload = {
        email,
        password,
        profile,
        pin,
        price,
        status,
        quantity: qtyVal ? Number(qtyVal) : 0,
        premium_until: premium_raw ? premium_raw : null,
      };

      try {
        const { error } = await supabase
          .from("stocks")
          .update(payload)
          .eq("id", id);
        if (error) throw error;

        showToast("‚úÖ Stock updated", "success");
        bootstrap.Modal.getInstance(document.getElementById("stockModal")).hide();
        await loadStocks();
        await refreshStats();
      } catch (err) {
        console.error("[saveStockEdit] error:", err);
        showToast("‚ùå Failed to update stock", "danger");
      }
    }

    // ========= ORDERS (PENDING + CONFIRM PAYMENT) =========
    async function loadPendingOrders()