<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Aiaxcart Premium | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    :root { --primary: #ffb0b5; --secondary: #ffd3d6; --dark: #382f2c; --light: #fefaf7; }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--light); color: var(--dark); font-family: "Segoe UI", sans-serif; }
    header { background: var(--secondary); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); position: sticky; top: 0; z-index: 50; }
    .header-inner { max-width: 1100px; margin: 0 auto; padding: 0.9rem 1.25rem; display: flex; align-items: center; justify-content: space-between; }
    .logo { font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 0.4rem; }
    .top-nav a { text-decoration: none; color: var(--dark); margin-left: 1rem; padding: 0.3rem 0.9rem; border-radius: 999px; font-weight: 500; }
    .top-nav a.active, .top-nav a:hover { background: var(--primary); color: #fff; }
    .admin-wrapper { max-width: 1100px; margin: 1.5rem auto 2.5rem; padding: 0 1.25rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { background: #fff; border-radius: 14px; padding: 1rem 1.2rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); }
    .stat-card h3 { margin: 0; font-size: 1.8rem; color: var(--primary); }
    .stat-card span { font-size: 0.9rem; color: #6a5c58; }
    .admin-layout { display: grid; grid-template-columns: 220px minmax(0, 1fr); gap: 1.25rem; margin-top: 1.5rem; align-items: flex-start; }
    .sidebar { background: #fff; border-radius: 16px; padding: 0.75rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); position: sticky; top: 5rem; }
    .sidebar button { width: 100%; text-align: left; border: none; background: transparent; padding: 0.45rem 0.8rem; border-radius: 999px; font-size: 0.92rem; margin-bottom: 0.3rem; cursor: pointer; color: #5a4b47; }
    .sidebar button.active { background: var(--primary); color: #fff; }
    .sidebar button i { width: 1rem; text-align: center; margin-right: 0.5rem; }
    .panel-admin { display: none; }
    .panel-admin.active { display: block; }
    .card-clean { background: #fff; border-radius: 16px; padding: 1.25rem 1.25rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); }
    .records-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .records-table th, .records-table td { border-bottom: 1px solid #eee; padding: 0.45rem 0.55rem; vertical-align: top; }
    .records-table th { background: #ffeef0; font-weight: 600; }
    .records-table tr:hover td { background: #fff7f8; }
    .toast-container { z-index: 9999; }
    .hidden { display: none !important; }
    @media (max-width: 900px) { .admin-layout { grid-template-columns: minmax(0, 1fr); } .sidebar { position: static; } .stats-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
  </style>
</head>

<body>
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <header>
    <div class="header-inner">
      <div class="logo"><span>ðŸ›’</span><span>Aiaxcart Premium â€“ Admin</span></div>
      <nav class="top-nav"><a href="./index.html">Home</a><a href="./admin.html" class="active">Admin</a></nav>
    </div>
  </header>

  <main class="admin-wrapper">
    <div id="adminGate" class="card-clean mb-3">
      <h2 class="h5 mb-2">Admin Security</h2>
      <div class="row g-2 align-items-end">
        <div class="col-md-6"><input id="adminUidInput" class="form-control" placeholder="Paste your UID"></div>
        <div class="col-md-3 d-grid"><button id="btnAdminLogin" class="btn btn-primary" type="button">Unlock Console</button></div>
      </div>
    </div>

    <div id="adminContent" class="hidden">
      <div class="stats-grid">
        <div class="stat-card"><h3 id="stat-products">0</h3><span>Products</span></div>
        <div class="stat-card"><h3 id="stat-stock">0</h3><span>Available Stocks</span></div>
        <div class="stat-card"><h3 id="stat-pending">0</h3><span>Pending Orders</span></div>
        <div class="stat-card"><h3 id="stat-revenue">â‚±0.00</h3><span>Total Revenue</span></div>
      </div>

      <div class="admin-layout">
        <aside class="sidebar">
          <button class="active" data-target="panel-products"><i class="fa fa-list"></i> Products</button>
          <button data-target="panel-add-stock"><i class="fa fa-plus-square"></i> Add Stock</button>
          <button data-target="panel-manage-stocks"><i class="fa fa-layer-group"></i> Stocks List</button>
          <button data-target="panel-pending-orders"><i class="fa fa-clock"></i> Pending Orders</button>
          <button data-target="panel-sold-orders"><i class="fa fa-check-circle"></i> Sold / Delivered</button>
          <button data-target="panel-records"><i class="fa fa-book"></i> All Records</button>
          <button data-target="panel-store-rules"><i class="fa fa-scroll"></i> Store Rules</button>
          <button data-target="panel-reports"><i class="fa fa-flag"></i> Reports</button>
        </aside>

        <section class="admin-main">

          <div id="panel-products" class="panel-admin active">
            <div class="card-clean">
              <h3 class="mb-3">Products</h3>
              <div class="mb-3 row g-2">
                <div class="col-md-3"><input id="new-prod-id" class="form-control" placeholder="ID (e.g. netflix)"></div>
                <div class="col-md-4"><input id="new-prod-name" class="form-control" placeholder="Name"></div>
                <div class="col-md-3"><input id="new-prod-cat" class="form-control" placeholder="Category"></div>
                <div class="col-md-2 d-grid"><button onclick="saveProduct()" class="btn btn-primary">Add</button></div>
              </div>
              <div class="table-responsive">
                <table class="records-table">
                  <thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Actions</th></tr></thead>
                  <tbody id="products-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="panel-add-stock" class="panel-admin">
            <div class="card-clean">
              <h3 class="mb-3">Add Stock</h3>
              <div class="row g-3">
                <div class="col-md-4"><label class="form-label">Product</label><select id="stock-product" class="form-select"></select></div>
                <div class="col-md-4"><label class="form-label">Account Type</label><input id="stock-account-type" class="form-control" placeholder="e.g. Solo"></div>
                <div class="col-md-4"><label class="form-label">Duration</label><input id="stock-duration" class="form-control" placeholder="e.g. 1m"></div>
                <div class="col-md-6"><input id="stock-email" class="form-control" placeholder="Email"></div>
                <div class="col-md-6"><input id="stock-password" class="form-control" placeholder="Password"></div>
                <div class="col-md-6"><input id="stock-profile" class="form-control" placeholder="Profile"></div>
                <div class="col-md-6"><input id="stock-pin" class="form-control" placeholder="PIN"></div>
                <div class="col-md-4"><input id="stock-archive-after" type="number" value="30" class="form-control" placeholder="Archive Days"></div>
                <div class="col-md-4"><input id="stock-premium-until" type="date" class="form-control"></div>
                <div class="col-md-4"><input id="stock-quantity" type="number" value="1" class="form-control" placeholder="Qty"></div>
                <div class="col-12"><button onclick="saveStock()" class="btn btn-primary">Save Stock</button></div>
              </div>
            </div>
          </div>

          <div id="panel-manage-stocks" class="panel-admin">
            <div class="card-clean">
              <h3>Stocks List</h3>
              <div class="table-responsive"><table class="records-table"><thead><tr><th>Product</th><th>Type</th><th>Email</th><th>Status</th><th>Qty</th><th>Actions</th></tr></thead><tbody id="stocks-table-body"></tbody></table></div>
            </div>
          </div>

          <div id="panel-pending-orders" class="panel-admin">
            <div class="card-clean">
              <h3>Pending Orders</h3>
              <div class="table-responsive"><table class="records-table"><thead><tr><th>Buyer</th><th>Product</th><th>Price</th><th>Payment</th><th>Status</th><th>Action</th></tr></thead><tbody id="orders-table-body"></tbody></table></div>
            </div>
          </div>

          <div id="panel-sold-orders" class="panel-admin">
            <div class="card-clean">
              <h3>Sold / Delivered Orders</h3>
              <div class="table-responsive"><table class="records-table"><thead><tr><th>Date</th><th>Buyer</th><th>Product</th><th>Ref #</th><th>Proof</th><th>Status</th></tr></thead><tbody id="sold-orders-table-body"></tbody></table></div>
            </div>
          </div>

          <div id="panel-records" class="panel-admin">
            <div class="card-clean">
              <div class="d-flex justify-content-between mb-3"><h3 class="mb-0">Records</h3><button onclick="exportRecordsCSV()" class="btn btn-sm btn-outline-secondary">Export CSV</button></div>
              <div class="table-responsive"><table class="records-table"><thead><tr><th>ID</th><th>Buyer</th><th>Product</th><th>Expiry</th><th>Price</th></tr></thead><tbody id="records-table-body"></tbody></table></div>
            </div>
          </div>

          <div id="panel-store-rules" class="panel-admin">
             <div class="card-clean">
               <h3>Store Rules</h3>
               <div class="input-group mb-3"><input id="rule-text" class="form-control" placeholder="Rule text"><input id="rule-product-id" class="form-control" placeholder="Product ID (opt)"><button onclick="addRule()" class="btn btn-primary">Add</button></div>
               <ul id="rules-list" class="list-unstyled"></ul>
             </div>
          </div>

          <div id="panel-reports" class="panel-admin">
            <div class="card-clean">
              <h3>Reports</h3>
              <div class="table-responsive"><table class="records-table"><thead><tr><th>ID</th><th>Order ID</th><th>Issue</th><th>Status</th></tr></thead><tbody id="reports-table-body"></tbody></table></div>
            </div>
          </div>

        </section>
      </div>
    </div>
  </main>

  <div class="modal fade" id="priceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Manage Prices: <span id="priceModalProdId"></span></h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <div class="row g-2 mb-3 border-bottom pb-3">
            <div class="col-3"><input id="new-price-type" class="form-control" placeholder="Type (e.g. Solo)"></div>
            <div class="col-3"><input id="new-price-dur" class="form-control" placeholder="Duration (e.g. 1m)"></div>
            <div class="col-3"><input id="new-price-val" type="number" class="form-control" placeholder="Price"></div>
            <div class="col-3"><button onclick="addPriceRow()" class="btn btn-primary w-100">Add</button></div>
          </div>
          <table class="table table-sm"><thead><tr><th>Type</th><th>Duration</th><th>Price</th><th>Action</th></tr></thead><tbody id="prices-table-body"></tbody></table>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://hnymqvkfmythdxtjqeam.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhueW1xdmtmbXl0aGR4dGpxZWFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMjE3NTUsImV4cCI6MjA3ODY5Nzc1NX0.4ww5fKNnbhNzNrkJZLa466b6BsKE_yYMO2YH6-auFlI";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const ADMIN_ALLOW_UIDS = ["5196f372-803a-4aec-9c46-72242e73a9b8"];
    
    let currentPriceProdId = null;

    function showToast(msg, type="info") {
      const box = document.getElementById("toastContainer");
      const el = document.createElement("div");
      el.className = `toast align-items-center text-bg-${type === 'error' ? 'danger' : type} border-0`;
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      box.appendChild(el);
      new bootstrap.Toast(el).show();
    }

    // AUTH
    document.getElementById("btnAdminLogin").addEventListener("click", async () => {
      const uid = document.getElementById("adminUidInput").value.trim();
      if (ADMIN_ALLOW_UIDS.includes(uid)) {
        document.getElementById("adminGate").classList.add("hidden");
        document.getElementById("adminContent").classList.remove("hidden");
        loadAllData();
      } else { showToast("Invalid UID", "error"); }
    });

    async function loadAllData() {
      loadProducts(); loadStocks(); loadPendingOrders(); loadSoldOrders(); loadRecords(); loadRules(); loadReports(); refreshStats();
    }

    // PRODUCTS & PRICES
    async function loadProducts() {
      const { data } = await supabase.from("products").select("*").order("name");
      const tbody = document.getElementById("products-table-body");
      const stockSel = document.getElementById("stock-product");
      tbody.innerHTML = ""; stockSel.innerHTML = "<option value=''>Select Product</option>";
      
      data.forEach(p => {
        tbody.innerHTML += `<tr>
          <td>${p.id}</td><td>${p.name}</td><td>${p.category}</td>
          <td>
            <button class="btn btn-sm btn-outline-dark me-1" onclick="openPriceModal('${p.id}')">Prices</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct('${p.id}')">Del</button>
          </td></tr>`;
        stockSel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
      });
    }

    async function saveProduct() {
      const id = document.getElementById("new-prod-id").value, name = document.getElementById("new-prod-name").value, cat = document.getElementById("new-prod-cat").value;
      if(!id || !name) return showToast("Fill ID and Name", "warning");
      await supabase.from("products").insert({ id, name, category: cat });
      showToast("Product Added", "success"); loadProducts();
    }

    async function deleteProduct(id) { if(confirm("Delete?")) { await supabase.from("products").delete().eq("id", id); loadProducts(); } }

    // PRICE MODAL LOGIC
    async function openPriceModal(pid) {
      currentPriceProdId = pid;
      document.getElementById("priceModalProdId").textContent = pid;
      new bootstrap.Modal(document.getElementById("priceModal")).show();
      loadPrices(pid);
    }

    async function loadPrices(pid) {
      const { data } = await supabase.from("product_prices").select("*").eq("product_id", pid);
      const tbody = document.getElementById("prices-table-body"); tbody.innerHTML = "";
      data.forEach(r => tbody.innerHTML += `<tr><td>${r.account_type}</td><td>${r.duration}</td><td>â‚±${r.price}</td><td><button class="btn btn-sm btn-danger" onclick="delPrice(${r.id})">X</button></td></tr>`);
    }

    async function addPriceRow() {
      const type=document.getElementById("new-price-type").value, dur=document.getElementById("new-price-dur").value, price=document.getElementById("new-price-val").value;
      if(!type || !dur || !price) return;
      await supabase.from("product_prices").insert({product_id: currentPriceProdId, account_type: type, duration: dur, price: price});
      loadPrices(currentPriceProdId);
    }
    async function delPrice(id) { await supabase.from("product_prices").delete().eq("id", id); loadPrices(currentPriceProdId); }

    // STOCKS
    async function saveStock() {
      const pid = document.getElementById("stock-product").value;
      if(!pid) return showToast("Select Product", "warning");
      const payload = {
        product_id: pid,
        account_type: document.getElementById("stock-account-type").value,
        duration: document.getElementById("stock-duration").value,
        email: document.getElementById("stock-email").value,
        password: document.getElementById("stock-password").value,
        profile: document.getElementById("stock-profile").value,
        pin: document.getElementById("stock-pin").value,
        quantity: document.getElementById("stock-quantity").value || 1,
        premium_until: document.getElementById("stock-premium-until").value || null,
        status: 'available'
      };
      await supabase.from("stocks").insert(payload);
      showToast("Stock Added", "success"); loadStocks(); refreshStats();
    }

    async function loadStocks() {
      const { data } = await supabase.from("stocks").select("*").order("created_at", {ascending: false});
      const tbody = document.getElementById("stocks-table-body"); tbody.innerHTML = "";
      data.forEach(s => tbody.innerHTML += `<tr><td>${s.product_id}</td><td>${s.account_type} / ${s.duration}</td><td>${s.email}</td><td>${s.status}</td><td>${s.quantity}</td><td><button class="btn btn-sm btn-danger" onclick="deleteStock(${s.id})">Del</button></td></tr>`);
    }
    async function deleteStock(id) { if(confirm("Delete?")) { await supabase.from("stocks").delete().eq("id", id); loadStocks(); } }

    // ORDERS & EXPIRY CALCULATION
    function calculateExpiry(dateIso, durationStr) {
      const d = new Date(dateIso); const dur = durationStr.toLowerCase();
      if(dur.includes('month') || dur.includes('m')) d.setMonth(d.getMonth() + (parseInt(dur)||1));
      else if(dur.includes('day') || dur.includes('d')) d.setDate(d.getDate() + (parseInt(dur)||30));
      else if(dur.includes('year') || dur.includes('y')) d.setFullYear(d.getFullYear() + (parseInt(dur)||1));
      else d.setDate(d.getDate() + 30);
      return d.toISOString();
    }

    async function loadPendingOrders() {
      const { data } = await supabase.from("orders").select("*").eq("status", "pending");
      const tbody = document.getElementById("orders-table-body"); tbody.innerHTML = data.length ? "" : "<tr><td colspan='6'>No pending orders.</td></tr>";
      data.forEach(o => {
        let proof = o.proof_image_url ? `<a href="${o.proof_image_url}" target="_blank">Proof</a>` : 'None';
        tbody.innerHTML += `<tr><td>${o.buyer_email}</td><td>${o.product_id}<br>${o.account_type}</td><td>â‚±${o.price}</td><td>${o.payment_method}<br>Ref:${o.reference_number}<br>${proof}</td><td>${o.status}</td><td><button class="btn btn-sm btn-success" onclick="markOrderPaid('${o.id}')">Confirm</button></td></tr>`;
      });
    }

    async function markOrderPaid(orderId) {
      if (!confirm("Confirm payment & delivery?")) return;
      const { data: order } = await supabase.from("orders").select("*").eq("id", orderId).single();
      
      // Find stock
      const { data: stock } = await supabase.from("stocks").select("*").eq("product_id", order.product_id).eq("account_type", order.account_type).eq("duration", order.duration).eq("status", "available").gt("quantity", 0).limit(1).maybeSingle();

      if (!stock) return showToast("No stock available for this combo!", "error");

      // Update Stock
      const newQty = stock.quantity - 1;
      const newStatus = newQty <= 0 ? 'sold' : 'available';
      await supabase.from("stocks").update({ quantity: newQty, status: newStatus }).eq("id", stock.id);

      // Create Record with Expiry
      const now = new Date().toISOString();
      const expiry = calculateExpiry(now, order.duration);
      
      await supabase.from("records").insert({
        order_id: order.id, buyer: order.buyer_email, source: "shop",
        product_id: order.product_id, account_type: order.account_type, duration: order.duration,
        price: order.price, purchase_date: now, expiry_date: expiry,
        account_email: stock.email, account_password: stock.password, profile: stock.profile, pin: stock.pin
      });

      // Update Order
      await supabase.from("orders").update({ status: "delivered" }).eq("id", orderId);
      
      showToast("Order Confirmed & Delivered!", "success");
      loadPendingOrders(); loadStocks(); loadSoldOrders(); refreshStats();
    }

    async function loadSoldOrders() {
      const { data } = await supabase.from("orders").select("*").eq("status", "delivered").order("created_at", {ascending: false});
      const tbody = document.getElementById("sold-orders-table-body"); tbody.innerHTML = data.length ? "" : "<tr><td colspan='6'>No sold orders.</td></tr>";
      data.forEach(o => {
         let proof = o.proof_image_url ? `<a href="${o.proof_image_url}" target="_blank">Proof</a>` : 'None';
         tbody.innerHTML += `<tr><td>${new Date(o.created_at).toLocaleDateString()}</td><td>${o.buyer_email}</td><td>${o.product_id}</td><td>${o.reference_number}</td><td>${proof}</td><td><span class="badge bg-success">Delivered</span></td></tr>`;
      });
    }

    // RECORDS, RULES, REPORTS (Retained)
    async function loadRecords() {
      const { data } = await supabase.from("records").select("*").order("created_at", {ascending: false});
      const tbody = document.getElementById("records-table-body"); tbody.innerHTML = "";
      data.forEach(r => tbody.innerHTML += `<tr><td>${r.id}</td><td>${r.buyer}</td><td>${r.product_id}</td><td>${r.expiry_date?new Date(r.expiry_date).toLocaleDateString():'-'}</td><td>â‚±${r.price}</td></tr>`);
    }
    async function exportRecordsCSV() {
       const { data } = await supabase.from("records").select("*");
       if(!data || !data.length) return showToast("No records", "warning");
       const headers = Object.keys(data[0]).join(",");
       const rows = data.map(row => Object.values(row).map(v => `"${v}"`).join(",")).join("\n");
       const blob = new Blob([headers + "\n" + rows], { type: "text/csv" });
       const url = URL.createObjectURL(blob);
       const a = document.createElement("a"); a.href = url; a.download = "records.csv"; a.click();
    }
    async function loadRules() {
      const { data } = await supabase.from("rules").select("*");
      const ul = document.getElementById("rules-list"); ul.innerHTML = "";
      data.forEach(r => ul.innerHTML += `<li>${r.rule_text} <button class="btn btn-sm btn-link text-danger" onclick="deleteRule(${r.id})">Del</button></li>`);
    }
    async function addRule() { await supabase.from("rules").insert({ rule_text: document.getElementById("rule-text").value, product_id: document.getElementById("rule-product-id").value || null }); loadRules(); }
    async function deleteRule(id) { await supabase.from("rules").delete().eq("id", id); loadRules(); }
    async function loadReports() {
      const { data } = await supabase.from("reports").select("*");
      const tbody = document.getElementById("reports-table-body"); tbody.innerHTML = "";
      data.forEach(r => tbody.innerHTML += `<tr><td>${r.id}</td><td>${r.order_id}</td><td>${r.issue_description}</td><td>${r.status}</td></tr>`);
    }

    async function refreshStats() {
      const { data: rData } = await supabase.from("records").select("price");
      const total = rData.reduce((sum, x) => sum + (x.price||0), 0);
      document.getElementById("stat-revenue").textContent = "â‚±" + total.toLocaleString();
      // Counts would be fetched similarly
    }

    // TABS
    document.querySelectorAll(".sidebar button").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".sidebar button").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".panel-admin").forEach(p => p.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.target).classList.add("active");
      });
    });
  </script>
</body>
</html>
